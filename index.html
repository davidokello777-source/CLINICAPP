<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALI MEDICALS v2.1 | HIMS Enterprise</title>
    <style>
        :root { 
            --primary: #1e3a8a; --secondary: #3b82f6; --accent: #10b981; 
            --danger: #ef4444; --warn: #f59e0b; --bg: #f1f5f9; --text: #0f172a;
        }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); font-size: 14px; }
        
        header { background: var(--primary); color: white; padding: 0.8rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        nav { background: white; padding: 0.5rem 2rem; display: flex; gap: 8px; border-bottom: 1px solid #cbd5e1; position: sticky; top: 0; z-index: 100; overflow-x: auto; }
        .container { padding: 20px; max-width: 1400px; margin: auto; }
        
        .card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 20px; }
        section { display: none; }
        .active { display: block; }
        
        button { padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .nav-btn { background: #e2e8f0; color: #475569; }
        .nav-btn.active { background: var(--secondary); color: white; }
        .btn-pay { background: var(--accent); color: white; }

        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; margin: 5px 0; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; font-size: 11px; color: #64748b; text-transform: uppercase; }

        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .stat-card { text-align: center; padding: 15px; border-radius: 8px; color: white; }
    </style>
</head>
<body>

<div id="loginPage" style="display:flex; justify-content:center; align-items:center; height:100vh; background: var(--primary);">
    <div class="card" style="width:350px; text-align:center;">
        <h2 style="color:var(--primary)">TALI MEDICALS</h2>
        <select id="roleSelect">
            <option>Reception</option>
            <option>Nurse</option>
            <option>Doctor</option>
            <option>Billing</option>
            <option>Lab</option>
            <option>Pharmacy</option>
            <option>Director</option>
        </select>
        <input type="password" id="loginPass" placeholder="Password (1234)">
        <button onclick="login()" class="btn-primary" style="width:100%; margin-top:10px;">Access System</button>
    </div>
</div>

<div id="app" style="display:none;">
    <header>
        <h3 style="margin:0;">TALI MEDICALS v2.1</h3>
        <div>
            <span id="displayUser" style="margin-right:15px; font-size: 12px; opacity: 0.8;"></span>
            <button onclick="location.reload()" style="background:transparent; color:white; border: 1px solid white;">Logout</button>
        </div>
    </header>
    <nav id="dynamicNav"></nav>

    <div class="container">
        
        <section id="sec-director">
            <div class="grid" style="margin-bottom: 20px;">
                <div class="stat-card" style="background: var(--primary);">
                    <div style="font-size: 12px; opacity: 0.8;">Today's Revenue</div>
                    <h2 id="dash-revenue">$0.00</h2>
                </div>
                <div class="stat-card" style="background: var(--accent);">
                    <div style="font-size: 12px; opacity: 0.8;">Today's Patients</div>
                    <h2 id="dash-pats">0</h2>
                </div>
                <div class="stat-card" style="background: var(--warn);">
                    <div style="font-size: 12px; opacity: 0.8;">Pending Bills</div>
                    <h2 id="dash-bills">0</h2>
                </div>
            </div>
            <div class="grid">
                <div class="card">
                    <h4>Low Stock Alert</h4>
                    <table id="dash-stock-table"></table>
                </div>
                <div class="card">
                    <h4>Patient Status Overview</h4>
                    <table id="dash-status-table"></table>
                </div>
            </div>
        </section>

        <section id="sec-reception">
            <div class="card">
                <h3>Patient Registration</h3>
                <div class="grid">
                    <div><label>Full Name</label><input id="pName"></div>
                    <div><label>Date of Birth</label><input type="date" id="pDob"></div>
                    <div><label>Gender</label><select id="pGender"><option>Male</option><option>Female</option></select></div>
                    <div><label>Phone</label><input id="pPhone"></div>
                </div>
                <button onclick="registerPatient()" class="btn-primary" style="margin-top:10px;">Register & Start Visit</button>
            </div>
            <div class="card">
                <input type="text" id="patSearch" placeholder="Search patients..." onkeyup="renderPatients()">
                <table id="table-pats"></table>
            </div>
        </section>

        <section id="sec-nurse">
            <div class="card">
                <h3>Waiting for Triage</h3>
                <table id="table-triage"></table>
            </div>
            <div id="triage-form" class="card" style="display:none;">
                <h4 id="triage-target"></h4>
                <div class="grid">
                    <div><label>BP</label><input id="vBP"></div>
                    <div><label>Temp (°C)</label><input type="number" step="0.1" id="vTemp"></div>
                    <div><label>Weight (kg)</label><input type="number" id="vWeight"></div>
                </div>
                <button onclick="submitTriage()" class="btn-primary" style="margin-top:10px;">Send to Doctor</button>
            </div>
        </section>

        <section id="sec-doctor">
            <div class="card"><table id="table-cons"></table></div>
            <div id="cons-form" class="card" style="display:none;">
                <h3 id="c-pat-name"></h3>
                <div id="c-history-box" style="background:#f8fafc; padding:10px; margin-bottom:15px; border-radius:5px; font-size:12px;"></div>
                <label>Diagnosis</label><input id="cDiagnosis">
                <label>Clinical Notes</label><textarea id="cNotes" rows="3"></textarea>
                <div class="grid">
                    <div><label>Order Lab</label><select id="cLabOrder"><option value="">-- No Test --</option><option value="Malaria RDT|5.00">Malaria RDT ($5)</option><option value="CBC|15.00">Full Blood Count ($15)</option></select></div>
                    <div><label>Prescribe Meds</label><select id="cMedPresc"><option value="">-- No Med --</option><option value="Amoxicillin|2.00">Amoxicillin ($2)</option><option value="Paracetamol|0.50">Paracetamol ($0.5)</option></select><input type="number" id="cMedQty" placeholder="Qty"></div>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button onclick="submitConsultation('WAITING_LAB')" class="btn-primary" style="background:var(--warn)">Order Lab</button>
                    <button onclick="submitConsultation('WAITING_BILLING')" class="btn-primary">Prescribe</button>
                </div>
            </div>
        </section>

        <section id="sec-billing">
            <div class="card"><h3>Outstanding Invoices</h3><table id="table-billing"></table></div>
        </section>

        <section id="sec-lab">
            <div class="card"><h3>Lab Requests</h3><table id="table-lab"></table></div>
            <div id="lab-entry" class="card" style="display:none;">
                <h4 id="lab-header"></h4>
                <textarea id="labResults" placeholder="Results..."></textarea>
                <button onclick="updateLab()" class="btn-primary">Release</button>
            </div>
        </section>

        <section id="sec-pharmacy">
            <div class="card"><h3>Prescriptions</h3><table id="table-pharm"></table></div>
            <div class="card"><h3>Inventory</h3><table id="table-inv"></table></div>
        </section>

    </div>
</div>

<script>
    let patients = JSON.parse(localStorage.getItem('tm_v2_pats')) || [];
    let visits = JSON.parse(localStorage.getItem('tm_v2_vists')) || [];
    let inventory = JSON.parse(localStorage.getItem('tm_v2_inv')) || [
        { name: "Amoxicillin", stock: 50, price: 2.00 },
        { name: "Paracetamol", stock: 10, price: 0.50 }
    ];
    let userRole = "";
    let activeVisitID = null;

    function save() {
        localStorage.setItem('tm_v2_pats', JSON.stringify(patients));
        localStorage.setItem('tm_v2_vists', JSON.stringify(visits));
        localStorage.setItem('tm_v2_inv', JSON.stringify(inventory));
    }

    function login() {
        if(document.getElementById('loginPass').value !== "1234") return alert("Wrong Password");
        userRole = document.getElementById('roleSelect').value;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('displayUser').innerText = `Role: ${userRole}`;
        renderNav();
        showSection(userRole.toLowerCase());
    }

    function renderNav() {
        const nav = document.getElementById('dynamicNav');
        const map = {
            "Reception": ['reception'], "Nurse": ['nurse'], "Doctor": ['doctor'],
            "Billing": ['billing'], "Lab": ['lab'], "Pharmacy": ['pharmacy'],
            "Director": ['director', 'reception', 'nurse', 'doctor', 'billing', 'lab', 'pharmacy']
        };
        nav.innerHTML = map[userRole].map(r => `<button id="btn-${r}" class="nav-btn" onclick="showSection('${r}')">${r.toUpperCase()}</button>`).join('');
    }

    function showSection(id) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
        document.getElementById('btn-' + id)?.classList.add('active');
        
        if(id === 'director') renderDashboard();
        if(id === 'reception') renderPatients();
        if(id === 'nurse') renderTriage();
        if(id === 'doctor') renderCons();
        if(id === 'billing') renderBilling();
        if(id === 'lab') renderLab();
        if(id === 'pharmacy') { renderPharm(); renderInv(); }
    }

    // --- DIRECTOR DASHBOARD LOGIC ---
    function renderDashboard() {
        const today = new Date().toLocaleDateString();
        const todayVisits = visits.filter(v => v.date === today);
        
        const revenue = todayVisits.reduce((sum, v) => {
            return sum + (v.isPaid ? v.bill.reduce((bSum, b) => bSum + b.price, 0) : 0);
        }, 0);

        document.getElementById('dash-revenue').innerText = `$${revenue.toFixed(2)}`;
        document.getElementById('dash-pats').innerText = todayVisits.length;
        document.getElementById('dash-bills').innerText = visits.filter(v => !v.isPaid).length;

        // Stock Alert (Items < 15)
        let sH = `<tr><th>Item</th><th>Stock</th></tr>`;
        inventory.filter(i => i.stock < 15).forEach(i => sH += `<tr style="color:red; font-weight:bold;"><td>${i.name}</td><td>${i.stock}</td></tr>`);
        document.getElementById('dash-stock-table').innerHTML = sH;

        // Status Table
        const stats = visits.reduce((acc, v) => { acc[v.status] = (acc[v.status] || 0) + 1; return acc; }, {});
        let tH = `<tr><th>Status</th><th>Count</th></tr>`;
        for(let s in stats) { tH += `<tr><td>${s.replace('_', ' ')}</td><td>${stats[s]}</td></tr>`; }
        document.getElementById('dash-status-table').innerHTML = tH;
    }

    // --- RECEPTION ---
    function registerPatient() {
        const name = document.getElementById('pName').value;
        const dob = document.getElementById('pDob').value;
        if(!name || !dob) return alert("Missing Info");
        const pId = "P-" + Date.now().toString().slice(-4);
        patients.push({ id: pId, name, dob, phone: document.getElementById('pPhone').value, gender: document.getElementById('pGender').value });
        
        const vId = "V-" + Date.now().toString().slice(-4);
        visits.push({
            id: vId, patId: pId, name: name, status: 'WAITING_TRIAGE', 
            date: new Date().toLocaleDateString(),
            timeline: [{ act: 'Registered', time: new Date().toLocaleTimeString() }],
            bill: [], isPaid: true
        });
        save(); renderPatients(); alert("Patient Registered");
    }

    function renderPatients() {
        const term = document.getElementById('patSearch').value.toLowerCase();
        let h = `<tr><th>Name</th><th>DOB</th><th>Action</th></tr>`;
        patients.filter(p => p.name.toLowerCase().includes(term)).forEach(p => {
            h += `<tr><td>${p.name}</td><td>${p.dob}</td><td><button onclick="startNewVisit('${p.id}', '${p.name}')">Start Visit</button></td></tr>`;
        });
        document.getElementById('table-pats').innerHTML = h;
    }

    function startNewVisit(patId, name) {
        const vId = "V-" + Date.now().toString().slice(-4);
        visits.push({
            id: vId, patId, name, status: 'WAITING_TRIAGE', 
            date: new Date().toLocaleDateString(),
            timeline: [{ act: 'New Visit', time: new Date().toLocaleTimeString() }],
            bill: [], isPaid: true
        });
        save(); alert("Re-queued");
    }

    // --- NURSE ---
    function renderTriage() {
        const q = visits.filter(v => v.status === 'WAITING_TRIAGE');
        let h = `<tr><th>Patient</th><th>Action</th></tr>`;
        q.forEach(v => h += `<tr><td>${v.name}</td><td><button onclick="openTriage('${v.id}')">Vitals</button></td></tr>`);
        document.getElementById('table-triage').innerHTML = h;
    }

    function openTriage(id) {
        activeVisitID = id;
        document.getElementById('triage-target').innerText = "Vitals: " + visits.find(v => v.id === id).name;
        document.getElementById('triage-form').style.display = 'block';
    }

    function submitTriage() {
        const v = visits.find(v => v.id === activeVisitID);
        v.timeline.push({ act: 'Vitals', val: `Temp: ${document.getElementById('vTemp').value}°C`, time: new Date().toLocaleTimeString() });
        v.status = 'WAITING_CONSULTATION';
        save(); document.getElementById('triage-form').style.display = 'none'; renderTriage();
    }

    // --- DOCTOR ---
    function renderCons() {
        const q = visits.filter(v => ['WAITING_CONSULTATION', 'LAB_READY'].includes(v.status));
        let h = `<tr><th>Patient</th><th>Status</th><th>Action</th></tr>`;
        q.forEach(v => h += `<tr><td>${v.name}</td><td>${v.status}</td><td><button onclick="openCons('${v.id}')">Examine</button></td></tr>`);
        document.getElementById('table-cons').innerHTML = h;
    }

    function openCons(id) {
        activeVisitID = id;
        const v = visits.find(v => v.id === id);
        document.getElementById('c-pat-name').innerText = v.name;
        document.getElementById('c-history-box').innerHTML = v.timeline.map(t => `<div><b>${t.act}:</b> ${t.val || ''}</div>`).join('');
        document.getElementById('cons-form').style.display = 'block';
    }

    function submitConsultation(nextStatus) {
        const v = visits.find(v => v.id === activeVisitID);
        const labRaw = document.getElementById('cLabOrder').value;
        const medRaw = document.getElementById('cMedPresc').value;
        const medQty = parseInt(document.getElementById('cMedQty').value) || 0;

        if(labRaw) {
            const [n, p] = labRaw.split('|');
            v.bill.push({ item: n, price: parseFloat(p), type: 'LAB' });
            v.isPaid = false; 
        }
        if(medRaw) {
            const [n, p] = medRaw.split('|');
            v.bill.push({ item: n, price: parseFloat(p) * medQty, type: 'MED', qty: medQty });
            v.isPaid = false;
        }
        v.status = nextStatus;
        save(); document.getElementById('cons-form').style.display = 'none'; renderCons();
    }

    // --- BILLING ---
    function renderBilling() {
        const q = visits.filter(v => v.isPaid === false);
        let h = `<tr><th>Patient</th><th>Total</th><th>Action</th></tr>`;
        q.forEach(v => {
            const total = v.bill.reduce((sum, i) => sum + i.price, 0);
            h += `<tr><td>${v.name}</td><td>$${total.toFixed(2)}</td><td><button class="btn-pay" onclick="payBill('${v.id}')">Pay</button></td></tr>`;
        });
        document.getElementById('table-billing').innerHTML = h;
    }

    function payBill(id) {
        const v = visits.find(v => v.id === id);
        v.isPaid = true;
        v.status = v.bill.some(b => b.type === 'LAB') ? 'WAITING_LAB' : 'WAITING_PHARMACY';
        save(); renderBilling();
    }

    // --- LAB ---
    function renderLab() {
        const q = visits.filter(v => v.status === 'WAITING_LAB' && v.isPaid);
        let h = `<tr><th>Patient</th><th>Test</th><th>Action</th></tr>`;
        q.forEach(v => {
            const test = v.bill.find(b => b.type === 'LAB').item;
            h += `<tr><td>${v.name}</td><td>${test}</td><td><button onclick="openLab('${v.id}')">Results</button></td></tr>`;
        });
        document.getElementById('table-lab').innerHTML = h;
    }

    function openLab(id) {
        activeVisitID = id;
        document.getElementById('lab-entry').style.display = 'block';
    }

    function updateLab() {
        const v = visits.find(v => v.id === activeVisitID);
        v.timeline.push({ act: 'Lab Result', val: document.getElementById('labResults').value, time: new Date().toLocaleTimeString() });
        v.status = 'LAB_READY';
        save(); document.getElementById('lab-entry').style.display = 'none'; renderLab();
    }

    // --- PHARMACY ---
    function renderPharm() {
        const q = visits.filter(v => v.status === 'WAITING_PHARMACY' && v.isPaid);
        let h = `<tr><th>Patient</th><th>Med</th><th>Action</th></tr>`;
        q.forEach(v => {
            const med = v.bill.find(b => b.type === 'MED');
            h += `<tr><td>${v.name}</td><td>${med.item} x${med.qty}</td><td><button onclick="dispense('${v.id}')">Dispense</button></td></tr>`;
        });
        document.getElementById('table-pharm').innerHTML = h;
    }

    function dispense(id) {
        const v = visits.find(v => v.id === id);
        const medOrder = v.bill.find(b => b.type === 'MED');
        const invItem = inventory.find(i => i.name === medOrder.item);
        if(invItem.stock >= medOrder.qty) {
            invItem.stock -= medOrder.qty;
            v.status = 'DISCHARGED';
            save(); renderPharm(); renderInv(); alert("Finalized");
        } else { alert("Out of Stock!"); }
    }

    function renderInv() {
        let h = `<tr><th>Item</th><th>Stock</th></tr>`;
        inventory.forEach(i => h += `<tr><td>${i.name}</td><td>${i.stock}</td></tr>`);
        document.getElementById('table-inv').innerHTML = h;
    }
</script>
</body>
</html>
