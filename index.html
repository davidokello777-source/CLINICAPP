<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TALI MEDICALS | Pro Cloud</title>
    <style>
        :root { --primary: #065f46; --danger: #991b1b; --warn: #b45309; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); }
        
        /* UI Components */
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; }
        nav { background: white; padding: 0.5rem; border-bottom: 1px solid #ddd; display: flex; gap: 5px; }
        .nav-btn { padding: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; }
        .nav-btn.active { background: var(--primary); color: white; }
        
        .container { padding: 20px; display: grid; grid-template-columns: 1fr; gap: 20px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; border: 1px solid #e2e8f0; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        tr:hover { background: #f1f5f9; }
        
        /* Alerts & Badges */
        .crit-flag { color: white; background: var(--danger); padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .bg-lab { background: #dbeafe; color: #1e40af; }
        .bg-ready { background: #dcfce7; color: #166534; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Form Layout */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="loginSection" style="text-align:center; padding-top:100px;">
    <div class="card" style="width:300px; margin:auto;">
        <h2>TALI MEDICALS</h2>
        <select id="userRole">
            <option value="Director">Director</option>
            <option value="Reception">Receptionist / Nurse</option>
            <option value="Doctor">General Doctor</option>
            <option value="ENT">ENT Specialist</option>
            <option value="Dental">Dentist</option>
            <option value="Lab">Lab Technician</option>
            <option value="Pharmacy">Pharmacist</option>
        </select>
        <input type="password" id="pass" placeholder="Password" style="margin-top:10px;">
        <button onclick="doLogin()" style="width:100%; margin-top:10px; background:var(--primary); color:white; border:none; padding:10px; cursor:pointer;">Login</button>
    </div>
</div>

<div id="mainApp" class="hidden">
    <header>
        <h3 id="brand">TALI MEDICALS</h3>
        <span id="roleLabel"></span>
    </header>
    <nav id="menu"></nav>

    <div class="container">
        <section id="sec-registration" class="hidden">
            <div class="card">
                <h3>Patient Enrollment</h3>
                <div class="form-grid">
                    <input id="pName" placeholder="Full Name">
                    <input id="pPhone" placeholder="Phone Number">
                    <input id="pAge" placeholder="Age/DOB">
                    <select id="pGender"><option>Male</option><option>Female</option></select>
                    <input id="pKin" placeholder="Next of Kin & Contact">
                </div>
                <button onclick="savePatient()" style="margin-top:15px; background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:4px;">Register & Start Visit</button>
            </div>
        </section>

        <section id="sec-triage" class="hidden">
            <div class="card">
                <h3>Vitals & Triage Queue</h3>
                <table id="triageTable"></table>
            </div>
            <div id="triageForm" class="card hidden">
                <h4 id="triageTarget"></h4>
                <div class="form-grid">
                    <input id="vBP" placeholder="BP (e.g. 150/90)">
                    <input id="vTemp" placeholder="Temp (°C)">
                    <input id="vWeight" placeholder="Weight (kg)">
                    <select id="vDest">
                        <option value="Doctor">General Medicine</option>
                        <option value="ENT">ENT Unit</option>
                        <option value="Dental">Dental Unit</option>
                        <option value="Lab">Direct to Lab</option>
                    </select>
                </div>
                <button onclick="submitTriage()" style="margin-top:10px;">Send to Next Station</button>
            </div>
        </section>

        <section id="sec-consultation" class="hidden">
            <div class="card">
                <h3>Consultation Queue</h3>
                <table id="consTable"></table>
            </div>
            <div id="consForm" class="card hidden">
                <h3 id="cName"></h3>
                <div id="cVitalsSummary" style="padding:10px; background:#f8fafc; border-radius:5px; margin-bottom:10px;"></div>
                
                <label>Presenting Complaints</label><textarea id="cComplaints"></textarea>
                <label>History & Examination</label><textarea id="cHist"></textarea>
                
                <div class="form-grid">
                    <div>
                        <label>Order Lab</label>
                        <select id="cLabSelect"><option value="">--Select Test--</option><option>Malaria RDT</option><option>CBC</option><option>Urinalysis</option></select>
                    </div>
                    <div>
                        <label>Prescribe</label>
                        <select id="cMedSelect"><option value="">--Select Drug--</option><option>Amoxicillin</option><option>Paracetamol</option><option>Ciprofloxacin</option></select>
                    </div>
                </div>
                <button onclick="submitConsultation()" style="margin-top:15px; background:var(--primary); color:white; border:none; padding:10px 20px;">Complete Visit</button>
            </div>
        </section>

        <section id="sec-lab" class="hidden">
            <div class="card">
                <h3>Lab Requests</h3>
                <table id="labTable"></table>
            </div>
            <div id="labForm" class="card hidden">
                <h4 id="labTarget"></h4>
                <input id="labResult" placeholder="Enter Findings/Results">
                <button onclick="submitLab()" style="margin-top:10px;">Send Results to Doctor</button>
            </div>
        </section>

        <section id="sec-pharmacy" class="hidden">
            <div class="card">
                <h3>Pharmacy Queue</h3>
                <table id="pharmTable"></table>
            </div>
        </section>
    </div>
</div>

<script>
    let patients = JSON.parse(localStorage.getItem('tp_patients')) || [];
    let visits = JSON.parse(localStorage.getItem('tp_visits')) || [];
    let role = "";
    let activeID = null;

    function doLogin() {
        role = document.getElementById('userRole').value;
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('roleLabel').innerText = "Access: " + role;
        renderMenu();
        showSec('registration');
    }

    function renderMenu() {
        const m = document.getElementById('menu');
        const roles = {
            "Director": ['registration', 'triage', 'consultation', 'lab', 'pharmacy'],
            "Reception": ['registration', 'triage'],
            "Doctor": ['consultation'], "ENT": ['consultation'], "Dental": ['consultation'],
            "Lab": ['lab'], "Pharmacy": ['pharmacy']
        };
        m.innerHTML = roles[role].map(s => `<button class="nav-btn" onclick="showSec('${s}')">${s.toUpperCase()}</button>`).join('');
    }

    function showSec(id) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById('sec-' + id).classList.remove('hidden');
        if(id === 'triage') renderTriage();
        if(id === 'consultation') renderCons();
        if(id === 'lab') renderLab();
        if(id === 'pharmacy') renderPharm();
    }

    // LOGIC: REGISTRATION
    function savePatient() {
        const id = "P-" + Date.now().toString().slice(-4);
        const p = { id, name: document.getElementById('pName').value, age: document.getElementById('pAge').value };
        patients.push(p);
        visits.push({ id: "V-"+Date.now().toString().slice(-4), patId: id, name: p.name, status: 'WAITING_TRIAGE', time: new Date().toLocaleTimeString() });
        save();
        alert("Patient Queued for Triage");
    }

    // LOGIC: TRIAGE
    function renderTriage() {
        const queue = visits.filter(v => v.status === 'WAITING_TRIAGE');
        let h = `<tr><th>Time</th><th>Patient</th><th>Action</th></tr>`;
        queue.forEach(v => h += `<tr><td>${v.time}</td><td>${v.name}</td><td><button onclick="openTriage('${v.id}')">Take Vitals</button></td></tr>`);
        document.getElementById('triageTable').innerHTML = h;
    }

    function openTriage(id) {
        activeID = id;
        const v = visits.find(v => v.id === id);
        document.getElementById('triageTarget').innerText = v.name;
        document.getElementById('triageForm').classList.remove('hidden');
    }

    function submitTriage() {
        const v = visits.find(v => v.id === activeID);
        v.vitals = { bp: document.getElementById('vBP').value, temp: document.getElementById('vTemp').value };
        v.dest = document.getElementById('vDest').value;
        // Automatic Red Flag Logic
        if(parseFloat(v.vitals.temp) > 38) v.priority = "HIGH";
        v.status = (v.dest === 'Lab') ? 'WAITING_LAB' : 'WAITING_CONSULTATION';
        save();
        document.getElementById('triageForm').classList.add('hidden');
        renderTriage();
    }

    // LOGIC: CONSULTATION
    function renderCons() {
        const queue = visits.filter(v => (v.status === 'WAITING_CONSULTATION' || v.status === 'LAB_READY') && (role === 'Director' || v.dest === role || v.dest === 'Doctor'));
        let h = `<tr><th>Patient</th><th>Status</th><th>Action</th></tr>`;
        queue.forEach(v => {
            let badge = v.status === 'LAB_READY' ? '<span class="badge bg-ready">Results In</span>' : '<span class="badge">Waiting</span>';
            let crit = v.priority === 'HIGH' ? '<span class="crit-flag">CRITICAL</span> ' : '';
            h += `<tr><td>${crit}${v.name}</td><td>${badge}</td><td><button onclick="openCons('${v.id}')">Examine</button></td></tr>`;
        });
        document.getElementById('consTable').innerHTML = h;
    }

    function openCons(id) {
        activeID = id;
        const v = visits.find(v => v.id === id);
        document.getElementById('cName').innerText = v.name;
        document.getElementById('cVitalsSummary').innerHTML = `<b>Vitals:</b> BP: ${v.vitals.bp} | Temp: ${v.vitals.temp}°C ${v.labResults ? ' | <b>Lab:</b> '+v.labResults : ''}`;
        document.getElementById('consForm').classList.remove('hidden');
    }

    function submitConsultation() {
        const v = visits.find(v => v.id === activeID);
        v.labOrder = document.getElementById('cLabSelect').value;
        v.prescription = document.getElementById('cMedSelect').value;
        
        if(v.labOrder && !v.labResults) {
            v.status = 'WAITING_LAB';
        } else {
            v.status = 'WAITING_PHARMACY';
        }
        save();
        document.getElementById('consForm').classList.add('hidden');
        renderCons();
    }

    // LOGIC: LAB
    function renderLab() {
        const queue = visits.filter(v => v.status === 'WAITING_LAB');
        let h = `<tr><th>Patient</th><th>Test Ordered</th><th>Action</th></tr>`;
        queue.forEach(v => h += `<tr><td>${v.name}</td><td>${v.labOrder}</td><td><button onclick="openLab('${v.id}')">Fill Result</button></td></tr>`);
        document.getElementById('labTable').innerHTML = h;
    }

    function openLab(id) {
        activeID = id;
        const v = visits.find(v => v.id === id);
        document.getElementById('labTarget').innerText = v.name + " - " + v.labOrder;
        document.getElementById('labForm').classList.remove('hidden');
    }

    function submitLab() {
        const v = visits.find(v => v.id === activeID);
        v.labResults = document.getElementById('labResult').value;
        v.status = 'LAB_READY'; // Sends back to Doctor
        save();
        document.getElementById('labForm').classList.add('hidden');
        renderLab();
    }

    // LOGIC: PHARMACY
    function renderPharm() {
        const queue = visits.filter(v => v.status === 'WAITING_PHARMACY');
        let h = `<tr><th>Patient</th><th>Medication</th><th>Action</th></tr>`;
        queue.forEach(v => h += `<tr><td>${v.name}</td><td>${v.prescription}</td><td><button onclick="completeVisit('${v.id}')">Dispense</button></td></tr>`);
        document.getElementById('pharmTable').innerHTML = h;
    }

    function completeVisit(id) {
        const v = visits.find(v => v.id === id);
        v.status = 'COMPLETED';
        save();
        renderPharm();
        alert("Dispensed and Visit Closed");
    }

    function save() {
        localStorage.setItem('tp_patients', JSON.stringify(patients));
        localStorage.setItem('tp_visits', JSON.stringify(visits));
    }
</script>
</body>
</html>
