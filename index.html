<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TALI MEDICALS v3.1 | HIMS</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
:root{--p:#1e3a8a;--s:#3b82f6;--a:#10b981;--d:#ef4444;--w:#f59e0b;--pu:#7c3aed;--bg:#f1f5f9;--tx:#0f172a;--bd:#e2e8f0;--mu:#64748b;--lt:#f8fafc;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--tx);font-size:14px;}
header{background:var(--p);color:#fff;padding:.6rem 1.2rem;display:flex;justify-content:space-between;align-items:center;gap:8px;}
nav{background:#fff;padding:.3rem 1rem;display:flex;gap:4px;border-bottom:2px solid var(--bd);position:sticky;top:0;z-index:100;overflow-x:auto;flex-wrap:wrap;}
.con{padding:12px;max-width:1600px;margin:auto;}
.card{background:#fff;padding:14px;border-radius:8px;border:1px solid var(--bd);box-shadow:0 1px 3px rgba(0,0,0,.05);margin-bottom:12px;}
section{display:none;}.active{display:block;}
button{padding:6px 11px;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:13px;transition:.15s;}
.bp{background:var(--p);color:#fff;}.bp:hover{opacity:.88;}
.nb{background:#e2e8f0;color:#475569;font-size:11px;padding:4px 9px;}.nb.active{background:var(--s);color:#fff;}
.ba{background:var(--a);color:#fff;}.bd2{background:var(--d);color:#fff;padding:3px 7px;font-size:11px;}
.bw{background:var(--w);color:#fff;}.bpu{background:var(--pu);color:#fff;}
.bo{background:transparent;border:1.5px solid var(--p);color:var(--p);}.bsm{padding:3px 8px;font-size:12px;}
.badd{background:var(--a);color:#fff;padding:4px 9px;font-size:12px;}
input,select,textarea{width:100%;padding:6px 8px;border:1.5px solid var(--bd);border-radius:5px;margin:2px 0;font-size:13px;font-family:inherit;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--s);box-shadow:0 0 0 3px rgba(59,130,246,.1);}
label{font-size:11px;font-weight:700;color:var(--mu);text-transform:uppercase;letter-spacing:.03em;display:block;margin-top:7px;}
.g{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:9px;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:9px;}
table{width:100%;border-collapse:collapse;margin-top:4px;}
th,td{padding:7px 9px;text-align:left;border-bottom:1px solid var(--lt);vertical-align:top;}
th{background:var(--lt);font-size:11px;color:var(--mu);text-transform:uppercase;font-weight:700;}
tr:hover td{background:#fafbff;}
.badge{display:inline-block;padding:2px 7px;border-radius:10px;font-size:11px;font-weight:700;}
.bp2{background:#fee2e2;color:#991b1b;}.bpa{background:#fef3c7;color:#92400e;}
.bpd{background:#d1fae5;color:#065f46;}.bbl{background:#dbeafe;color:#1e40af;}
.bgr{background:#f1f5f9;color:#475569;}.bpu2{background:#ede9fe;color:#5b21b6;}
.bgn{background:#d1fae5;color:#065f46;}.bwn{background:#fef3c7;color:#92400e;}
.sc{text-align:center;padding:12px;border-radius:8px;color:#fff;}
.cb{border:1.5px solid var(--bd);border-radius:7px;margin-bottom:7px;overflow:hidden;}
.ch{background:var(--lt);padding:8px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:13px;user-select:none;}
.ch:hover{background:#e8edf4;}.ch .cr{font-size:11px;transition:.2s;}.ch.open .cr{transform:rotate(180deg);}
.cbody{display:none;padding:10px 12px;}.cbody.open{display:block;}
.or{display:grid;gap:7px;align-items:end;background:var(--lt);border:1.5px solid var(--bd);border-radius:6px;padding:8px;margin-bottom:6px;}
.or.lr{grid-template-columns:1fr auto;}.or.mr{grid-template-columns:1.2fr .8fr .5fr auto;}
.or.rr{grid-template-columns:1fr auto;}.or label{margin:0;}
.osum{background:#eff6ff;border:1.5px solid #bfdbfe;border-radius:7px;padding:10px;margin:10px 0;}
.osum h5{color:var(--p);margin:0 0 6px 0;font-size:11px;text-transform:uppercase;}
.si{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px dashed #bfdbfe;font-size:13px;}
.si:last-child{border:none;font-weight:700;color:var(--p);}
.tag{display:inline-block;padding:1px 5px;border-radius:7px;font-size:10px;font-weight:700;margin-right:2px;}
.tl{background:#fef3c7;color:#92400e;}.tm{background:#d1fae5;color:#065f46;}.tc{background:#dbeafe;color:#1e40af;}
.tr2{background:#ede9fe;color:#5b21b6;}.tp{background:#fee2e2;color:#991b1b;}
.emp{text-align:center;color:#94a3b8;font-style:italic;font-size:12px;padding:10px;}
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:500;justify-content:center;align-items:flex-start;padding:28px 12px;overflow-y:auto;}
.mo.open{display:flex;}.mb{background:#fff;border-radius:10px;width:100%;max-width:840px;padding:20px;position:relative;margin:auto;}
.mc{position:absolute;top:11px;right:11px;background:none;border:none;font-size:19px;cursor:pointer;color:var(--mu);}
.ab{display:flex;gap:6px;flex-wrap:wrap;margin-top:11px;padding-top:11px;border-top:1px solid var(--bd);}
hr.dv{border:none;border-top:1.5px solid var(--bd);margin:12px 0;}
.dc{display:inline-block;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:600;background:#d1fae5;color:#065f46;margin:1px;}
.pb{font-size:11px;font-weight:700;padding:2px 6px;border-radius:10px;}
.stabs{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;}
.st{padding:5px 11px;border-radius:5px;cursor:pointer;font-size:12px;font-weight:600;background:#e2e8f0;color:#475569;border:none;}
.st.active{background:var(--s);color:#fff;}
.ti{display:flex;gap:7px;padding:4px 0;border-bottom:1px dashed var(--bd);}
.ti:last-child{border:none;}.tt{font-size:11px;color:var(--mu);white-space:nowrap;min-width:58px;}
.tb{font-size:11px;color:var(--s);font-style:italic;}
.lrc{background:var(--lt);border-left:4px solid var(--a);padding:8px 12px;border-radius:5px;margin-bottom:6px;}
.chart-box{position:relative;height:220px;}
.it{width:auto;height:auto;border:none;padding:0;margin:0;}
.invt{width:auto;height:auto;margin:0;}
.cb2{border:1.5px solid var(--bd);border-radius:6px;padding:8px;margin-bottom:6px;background:var(--lt);}
.drug-search-results{max-height:200px;overflow-y:auto;border:1.5px solid var(--bd);border-radius:5px;background:#fff;margin-top:2px;}
.drug-item{padding:8px 10px;cursor:pointer;border-bottom:1px solid var(--lt);font-size:13px;}
.drug-item:hover{background:#eff6ff;}.drug-item.selected{background:#dbeafe;}
.lab-check-list{max-height:220px;overflow-y:auto;border:1.5px solid var(--bd);border-radius:5px;background:#fff;padding:6px;}
.lab-check-item{display:flex;align-items:center;gap:7px;padding:5px 6px;border-radius:4px;cursor:pointer;font-size:13px;}
.lab-check-item:hover{background:#eff6ff;}
.lab-check-item input[type=checkbox]{width:auto;margin:0;}
.formulation-badge{display:inline-block;padding:1px 6px;border-radius:8px;font-size:11px;font-weight:600;margin-left:4px;}
.f-tab{background:#e0e7ff;color:#3730a3;}
.f-cap{background:#fce7f3;color:#9d174d;}
.f-syr{background:#d1fae5;color:#065f46;}
.f-inj{background:#fee2e2;color:#991b1b;}
.f-inh{background:#fef3c7;color:#92400e;}
.f-cre{background:#e0f2fe;color:#0369a1;}
.f-oth{background:#f3f4f6;color:#374151;}
.bmi-badge{display:inline-block;padding:3px 10px;border-radius:10px;font-size:12px;font-weight:700;margin-left:8px;}
@media print{body>*:not(#pra){display:none!important;}#pra{display:block!important;}}
#pra{display:none;}
.pit{width:100%;border-collapse:collapse;margin:8px 0;}
.pit th,.pit td{padding:5px 8px;border:1px solid #ccc;font-size:12px;}
.pit th{background:#f0f0f0;}
#ls{position:fixed;inset:0;background:var(--p);display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;z-index:9999;}
.spin{width:38px;height:38px;border:4px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp 1s linear infinite;margin-bottom:12px;}
@keyframes sp{to{transform:rotate(360deg);}}
.si2{font-size:10px;padding:2px 7px;border-radius:10px;background:rgba(255,255,255,.12);color:#fff;}
.cg{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:7px;}
.cr2{background:#fff;border:1px solid var(--bd);border-radius:4px;padding:4px 7px;font-size:11px;}
.sp2{display:inline-block;padding:2px 7px;border-radius:10px;font-size:11px;font-weight:600;background:#dbeafe;color:#1e40af;margin:2px;}
.exp-cat{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;}
details summary{cursor:pointer;font-weight:600;font-size:12px;color:var(--p);}
.consult-type-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;}
.ct-gen{background:#dbeafe;color:#1e40af;}
.ct-lab{background:#d1fae5;color:#065f46;}
.ct-rad{background:#ede9fe;color:#5b21b6;}
.ct-spc{background:#fef3c7;color:#92400e;}
</style>
</head>
<body>
<div id="ls"><div class="spin"></div><div style="font-size:17px;font-weight:700;">TALI MEDICALS</div><div style="opacity:.7;font-size:11px;margin-top:4px;">Loading v3.1...</div></div>

<!-- LOGIN -->
<div id="lp" style="display:none;justify-content:center;align-items:center;min-height:100vh;background:var(--p);">
  <div class="card" style="width:390px;text-align:center;">
    <h2 style="color:var(--p);margin-bottom:3px;">ğŸ¥ TALI MEDICALS</h2>
    <p style="color:var(--mu);font-size:12px;margin-bottom:12px;">Hospital Information System v3.1</p>
    <label style="text-align:left;">Username</label><input id="lu" placeholder="Username" onkeyup="if(event.key==='Enter')login()">
    <label style="text-align:left;">Password</label><input type="password" id="lp2" placeholder="Password" onkeyup="if(event.key==='Enter')login()">
    <button onclick="login()" class="bp" style="width:100%;margin-top:11px;padding:9px;">Sign In</button>
    <div id="le" style="color:var(--d);font-size:12px;margin-top:6px;min-height:16px;"></div>
    <div style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.25);border-radius:6px;padding:8px;margin-top:10px;">
      <details><summary>Demo Credentials</summary>
        <div class="cg">
          <div class="cr2"><b>Director</b><br>director/dir123</div>
          <div class="cr2"><b>Reception</b><br>reception1/rec123</div>
          <div class="cr2"><b>Nurse</b><br>nurse1/nur123</div>
          <div class="cr2"><b>Doctor</b><br>doctor1/doc123</div>
          <div class="cr2"><b>Billing</b><br>billing1/bil123</div>
          <div class="cr2"><b>Lab</b><br>lab1/lab123</div>
          <div class="cr2"><b>Pharmacy</b><br>pharmacy1/pha123</div>
        </div>
      </details>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <header>
    <h3 style="font-size:15px;white-space:nowrap;">ğŸ¥ TALI MEDICALS <span style="font-size:10px;opacity:.4;">v3.1</span></h3>
    <div style="display:flex;align-items:center;gap:9px;flex-wrap:wrap;">
      <span id="du" style="font-size:12px;opacity:.85;"></span>
      <span id="si3" class="si2"></span>
      <button onclick="location.reload()" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35);font-size:12px;padding:4px 8px;">Logout</button>
    </div>
  </header>
  <nav id="dn"></nav>
  <div class="con">

    <!-- DIRECTOR -->
    <section id="sec-director">
      <!-- Stat Cards -->
      <div class="g4" style="margin-bottom:12px;">
        <div class="sc" style="background:var(--p)"><div style="font-size:11px;opacity:.8;">Today Revenue</div><h2 id="d-rev" style="margin:3px 0;">$0</h2></div>
        <div class="sc" style="background:#dc2626"><div style="font-size:11px;opacity:.8;">Today Expenses</div><h2 id="d-exp" style="margin:3px 0;">$0</h2></div>
        <div class="sc" style="background:var(--a)"><div style="font-size:11px;opacity:.8;">Today Patients</div><h2 id="d-pats" style="margin:3px 0;">0</h2></div>
        <div class="sc" style="background:var(--w)"><div style="font-size:11px;opacity:.8;">Outstanding Debt</div><h2 id="d-debt" style="margin:3px 0;">$0</h2></div>
        <div class="sc" style="background:var(--pu)"><div style="font-size:11px;opacity:.8;">Stock Value</div><h2 id="d-stock-val" style="margin:3px 0;">$0</h2></div>
        <div class="sc" style="background:#0f766e"><div style="font-size:11px;opacity:.8;">Admitted</div><h2 id="d-adm" style="margin:3px 0;">0</h2></div>
        <div class="sc" style="background:#b45309"><div style="font-size:11px;opacity:.8;">Lab Tests Today</div><h2 id="d-labs" style="margin:3px 0;">0</h2></div>
        <div class="sc" style="background:#6d28d9"><div style="font-size:11px;opacity:.8;">Discharged Today</div><h2 id="d-disc" style="margin:3px 0;">0</h2></div>
      </div>
      <!-- Charts Row 1 -->
      <div class="g2">
        <div class="card"><h4 style="margin-bottom:8px;">ğŸ“ˆ Revenue vs Expenses (Last 7 Days)</h4><div class="chart-box"><canvas id="ch-revexp"></canvas></div></div>
        <div class="card"><h4 style="margin-bottom:8px;">ğŸ‘¥ Patient Visits This Month</h4><div class="chart-box"><canvas id="ch-visits"></canvas></div></div>
      </div>
      <!-- Charts Row 2 -->
      <div class="g2">
        <div class="card"><h4 style="margin-bottom:8px;">ğŸ’³ Debt Analysis</h4><div style="display:flex;align-items:center;gap:12px;"><div style="width:160px;height:160px;"><canvas id="ch-debt"></canvas></div><div id="debt-legend" style="font-size:12px;"></div></div></div>
        <div class="card"><h4 style="margin-bottom:8px;">ğŸ”¬ Top Lab Tests This Month</h4><div class="chart-box"><canvas id="ch-labs"></canvas></div></div>
      </div>
      <!-- Stock + Low stock -->
      <div class="g2">
        <div class="card"><h4 style="margin-bottom:8px;">ğŸ“¦ Stock Value by Category</h4><table id="d-stockval"></table></div>
        <div class="card"><h4 style="margin-bottom:8px;">âš  Low Stock Alerts</h4><table id="d-lowstock"></table></div>
      </div>
    </section>

    <!-- RECEPTION -->
    <section id="sec-reception">
      <div class="card">
        <h3 style="margin-bottom:11px;">Patient Registration</h3>
        <div class="g">
          <div><label>Full Name *</label><input id="pName" placeholder="Full name"></div>
          <div><label>Gender *</label><select id="pGender"><option>Male</option><option>Female</option></select></div>
          <div><label>Age *</label><div style="display:flex;gap:5px;margin-top:2px;"><input type="number" id="pAgeVal" placeholder="32" min="0" style="width:55%;margin:0;"><select id="pAgeUnit" style="width:45%;margin:0;"><option value="years">Years</option><option value="months">Months</option><option value="days">Days</option></select></div></div>
          <div><label>Phone</label><input id="pPhone" placeholder="+233..."></div>
          <div><label>Address</label><input id="pAddress" placeholder="Street, City"></div>
          <div><label>Next of Kin</label><input id="pKinName" placeholder="Name"></div>
          <div><label>Kin Phone</label><input id="pKinPhone" placeholder="+233..."></div>
        </div>
        <div class="g2" style="margin-top:8px;">
          <div>
            <label>Consultation Type *</label>
            <select id="pConsultType">
              <option value="GENERAL">General Consultation</option>
              <option value="LAB_ONLY">Lab Only</option>
              <option value="RADIOLOGY">Radiology</option>
              <option value="DENTAL">Special â€” Dental</option>
              <option value="ENT">Special â€” ENT</option>
              <option value="OTHER_SPECIAL">Special â€” Other</option>
            </select>
          </div>
          <div><label>Notes / Reason for Visit</label><input id="pRegNote" placeholder="Brief reason for visit"></div>
        </div>
        <button onclick="registerPatient()" class="bp" style="margin-top:11px;">Register & Route Patient</button>
      </div>
      <div class="card">
        <input id="patSearch" placeholder="Search patients by name..." onkeyup="renderPatients()" style="margin-bottom:8px;">
        <table id="table-pats"></table>
      </div>
    </section>

    <!-- NURSE -->
    <section id="sec-nurse">
      <div class="stabs">
        <button class="st active" onclick="swNurse('triage',this)">ğŸ©º Triage Queue</button>
        <button class="st" onclick="swNurse('treatment',this)">ğŸ’‰ Treatment Chart</button>
        <button class="st" onclick="swNurse('reg',this)">â• Register Patient</button>
      </div>
      <div id="nurse-triage">
        <div class="card"><h4 style="margin-bottom:8px;">Patients Awaiting Triage</h4><table id="table-triage"></table></div>
        <div id="triage-form" class="card" style="display:none;">
          <h4 id="triage-target" style="color:var(--p);margin-bottom:9px;"></h4>
          <div class="g">
            <div><label>BP (mmHg)</label><input id="vBP" placeholder="120/80"></div>
            <div><label>Temp (Â°C)</label><input type="number" step="0.1" id="vTemp" placeholder="37.2"></div>
            <div><label>Weight (kg)</label><input type="number" id="vWeight" placeholder="70" onchange="calcBMI()"></div>
            <div><label>Height (cm)</label><input type="number" id="vHeight" placeholder="170" onchange="calcBMI()"></div>
            <div><label>Pulse (bpm)</label><input type="number" id="vPulse" placeholder="78"></div>
            <div><label>SpO2 (%)</label><input type="number" id="vSpO2" placeholder="98"></div>
            <div><label>Resp Rate (/min)</label><input type="number" id="vRR" placeholder="16"></div>
            <div>
              <label>BMI <span id="bmi-val" style="font-size:12px;font-weight:400;"></span></label>
              <div id="bmi-display" style="padding:8px;background:var(--lt);border-radius:5px;min-height:34px;font-size:13px;color:var(--mu);margin-top:2px;">Enter weight and height</div>
            </div>
          </div>
          <div class="ab">
            <button onclick="submitTriage()" class="bp">Send to Doctor</button>
            <button onclick="document.getElementById('triage-form').style.display='none'" style="background:#e2e8f0;color:#475569;">Cancel</button>
          </div>
        </div>
      </div>
      <div id="nurse-treatment" style="display:none;">
        <div class="card"><h4 style="margin-bottom:8px;">Active Patients â€” Treatment Chart</h4><table id="table-treat-pats"></table></div>
        <div id="treatment-detail" class="card" style="display:none;">
          <h4 id="treat-name" style="color:var(--p);margin-bottom:8px;"></h4>
          <div id="treat-orders" style="background:var(--lt);border-radius:6px;padding:9px;margin-bottom:10px;font-size:13px;"></div>
          <div class="g"><div><label>Drug / Treatment</label><input id="tDrug" placeholder="e.g. Ampicillin"></div><div><label>Dose</label><input id="tDose" placeholder="e.g. 500mg"></div><div><label>Route</label><select id="tRoute"><option>IV</option><option>IM</option><option>PO</option><option>SC</option><option>PR</option><option>SL</option><option>Topical</option><option>Inhalation</option></select></div><div><label>Time Given</label><input type="time" id="tTime"></div></div>
          <label>Observations</label><textarea id="tNotes" rows="2" placeholder="Patient response, observations..."></textarea>
          <div class="ab"><button onclick="addTreatEntry()" class="ba">Add Entry</button><button onclick="document.getElementById('treatment-detail').style.display='none'" style="background:#e2e8f0;color:#475569;">Close</button></div>
          <div id="existing-treats" style="margin-top:12px;"></div>
        </div>
      </div>
      <div id="nurse-reg" style="display:none;"></div>
    </section>

    <!-- DOCTOR -->
    <section id="sec-doctor">
      <div class="stabs">
        <button class="st active" onclick="swDoc('queue',this)">ğŸ“‹ Queue</button>
        <button class="st" onclick="swDoc('allpats',this)">ğŸ“ All Patients</button>
        <button class="st" onclick="swDoc('reg',this)">â• Register</button>
      </div>
      <div id="doc-queue">
        <div class="card"><table id="table-cons"></table></div>
        <div id="cons-form" class="card" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:11px;">
            <div><h3 id="c-name" style="color:var(--p);margin:0;"></h3><span id="c-type-badge" style="margin-top:3px;display:inline-block;"></span></div>
            <div style="display:flex;gap:5px;align-items:center;"><span id="c-date" style="font-size:12px;color:var(--mu);"></span><span id="c-pay"></span></div>
          </div>
          <div id="c-hist" style="background:var(--lt);border-left:3px solid var(--s);padding:8px 12px;border-radius:5px;margin-bottom:12px;font-size:12px;max-height:100px;overflow-y:auto;"></div>
          <!-- Vitals summary -->
          <div id="c-vitals" style="display:none;background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:6px;padding:9px;margin-bottom:12px;font-size:13px;"></div>
          <!-- Lab results -->
          <div id="lab-res-panel" style="display:none;margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <h4 style="color:var(--a);margin:0;">ğŸ”¬ Lab Results</h4>
              <button onclick="printLabResults()" class="bsm bo">ğŸ–¨ Print Lab PDF</button>
            </div>
            <div id="lab-res-display"></div>
          </div>
          <!-- Radiology results -->
          <div id="rad-res-panel" style="display:none;margin-bottom:12px;">
            <h4 style="color:var(--pu);margin-bottom:8px;">ğŸ“¡ Radiology Results</h4>
            <div id="rad-res-display"></div>
          </div>
          <!-- Clinical History -->
          <p style="font-size:11px;font-weight:700;color:var(--mu);text-transform:uppercase;margin-bottom:7px;">Clinical History</p>
          <div class="cb"><div class="ch" onclick="tClin(this)"><span>ğŸ“‹ Presenting Complaint</span><span class="cr">â–¼</span></div><div class="cbody"><textarea id="hPC" rows="2" placeholder="Chief complaint..."></textarea></div></div>
          <div class="cb"><div class="ch" onclick="tClin(this)"><span>ğŸ“– History of Presenting Complaint</span><span class="cr">â–¼</span></div><div class="cbody"><textarea id="hHPC" rows="3" placeholder="Duration, onset, character..."></textarea></div></div>
          <div class="cb"><div class="ch" onclick="tClin(this)"><span>ğŸ¥ Past Medical / Surgical History</span><span class="cr">â–¼</span></div><div class="cbody"><textarea id="hPMH" rows="3" placeholder="Previous illnesses, operations..."></textarea></div></div>
          <div class="cb" id="ogBlock" style="display:none;"><div class="ch" onclick="tClin(this)"><span>ğŸŒ¸ Obs/Gyn <span style="font-size:11px;color:var(--a);font-weight:400;">(Female)</span></span><span class="cr">â–¼</span></div><div class="cbody"><div class="g2"><div><label>LMP</label><input id="hLMP"></div><div><label>Gravida/Para</label><input id="hGP"></div></div><textarea id="hOG" rows="2" placeholder="Obs/Gyn notes..." style="margin-top:6px;"></textarea></div></div>
          <div class="cb"><div class="ch" onclick="tClin(this)"><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family & Social History</span><span class="cr">â–¼</span></div><div class="cbody"><textarea id="hFSH" rows="2" placeholder="Family illnesses, occupation..."></textarea></div></div>
          <div class="cb"><div class="ch" onclick="tClin(this)"><span>ğŸ’Š Drug History & Allergies</span><span class="cr">â–¼</span></div><div class="cbody"><textarea id="hDrug" rows="2" placeholder="Current medications..."></textarea><label>Allergies</label><input id="hAllergy" placeholder="e.g. Penicillin â€” rash. None known."></div></div>
          <hr class="dv">
          <label>Differential Diagnosis</label><textarea id="cDiffDx" rows="2" placeholder="Differentials being considered..."></textarea>
          <hr class="dv">
          <!-- LAB ORDERS (multi-select searchable) -->
          <div id="lab-order-sec">
            <p style="font-size:11px;font-weight:700;color:var(--mu);text-transform:uppercase;margin-bottom:6px;">ğŸ”¬ Lab Orders</p>
            <input id="lab-search" placeholder="Search lab tests..." onkeyup="filterLabTests()" style="margin-bottom:6px;">
            <div class="lab-check-list" id="lab-check-list"></div>
            <div id="selected-labs-display" style="margin-top:6px;"></div>
          </div>
          <hr class="dv">
          <!-- RADIOLOGY ORDERS -->
          <div>
            <p style="font-size:11px;font-weight:700;color:var(--mu);text-transform:uppercase;margin-bottom:6px;">ğŸ“¡ Radiology / Imaging</p>
            <div id="rad-orders-list"></div>
            <button class="badd" onclick="addRadRow()">+ Add Procedure</button>
          </div>
          <hr class="dv">
          <!-- FINAL DX -->
          <label>Final Diagnosis</label><input id="cFinalDx" placeholder="Final/confirmed diagnosis...">
          <label>Clinical Notes / Plan</label><textarea id="cNotes" rows="2" placeholder="Management plan, instructions..."></textarea>
          <hr class="dv">
          <!-- PRESCRIPTION (formulation-aware) -->
          <div>
            <p style="font-size:11px;font-weight:700;color:var(--mu);text-transform:uppercase;margin-bottom:6px;">ğŸ’Š Prescription Orders</p>
            <input id="med-search" placeholder="Search drug by name, class or formulation..." onkeyup="filterMeds()" style="margin-bottom:5px;">
            <div class="drug-search-results" id="drug-results" style="display:none;"></div>
            <div id="med-orders-list"></div>
          </div>
          <!-- Order Summary -->
          <div class="osum"><h5>ğŸ“‹ Current Visit Bill</h5><div id="order-sum-body"><div class="emp">No orders yet.</div></div></div>
          <!-- Actions -->
          <div class="ab" id="cons-actions"></div>
        </div>
      </div>
      <div id="doc-allpats" style="display:none;">
        <div class="card">
          <h4 style="margin-bottom:8px;">All Patients â€” Cumulative Records</h4>
          <div class="g2" style="margin-bottom:8px;">
            <input id="allpat-search" placeholder="Search by name..." onkeyup="renderAllPats()" style="margin:0;">
            <input type="number" id="allpat-age" placeholder="Filter by age..." onkeyup="renderAllPats()" style="margin:0;">
          </div>
          <table id="table-allpats"></table>
        </div>
      </div>
      <div id="doc-reg" style="display:none;"></div>
    </section>

    <!-- BILLING -->
    <section id="sec-billing">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:9px;flex-wrap:wrap;gap:6px;">
        <h3>Billing & Payments</h3>
        <button onclick="exportCSV()" class="bo bsm">â¬‡ Export CSV</button>
      </div>
      <div class="stabs">
        <button class="st active" onclick="fBill('all',this)">All</button>
        <button class="st" onclick="fBill('PENDING',this)">Unpaid</button>
        <button class="st" onclick="fBill('PARTIAL',this)">Partial</button>
        <button class="st" onclick="fBill('PAID',this)">Paid</button>
      </div>
      <div class="card" style="padding:9px;"><table id="table-bill"></table></div>
      <div id="pay-modal" class="mo">
        <div class="mb" style="max-width:560px;">
          <button class="mc" onclick="cModal('pay-modal')">âœ•</button>
          <h3 id="pay-title" style="color:var(--p);margin-bottom:11px;"></h3>
          <details open><summary style="margin-bottom:7px;">Bill Items</summary><div id="pay-breakdown"></div></details>
          <hr class="dv">
          <div class="g2" style="margin-bottom:9px;">
            <div><label>Discount ($)</label><input type="number" id="discAmt" placeholder="0.00" min="0" step="0.01" onchange="updPayBal()"></div>
            <div><label>Discount Reason</label><input id="discReason" placeholder="e.g. Staff, Indigent..."></div>
          </div>
          <div id="pay-bal" style="font-size:13px;font-weight:700;margin-bottom:11px;padding:9px;background:var(--lt);border-radius:6px;"></div>
          <label>Payment Method</label><select id="payMethod"><option>Cash</option><option>Mobile Money</option><option>Insurance</option><option>Bank Transfer</option><option>Cheque</option></select>
          <label>Amount Paying ($)</label><input type="number" id="payAmt" placeholder="Amount" step="0.01" min="0.01" onchange="updPayBal()">
          <div class="ab"><button onclick="recPayment()" class="ba">Record Payment</button><button onclick="cModal('pay-modal')" style="background:#e2e8f0;color:#475569;">Cancel</button></div>
        </div>
      </div>
    </section>

    <!-- LAB -->
    <section id="sec-lab">
      <div class="stabs">
        <button class="st active" onclick="swLab('pending',this)">ğŸ”¬ Pending</button>
        <button class="st" onclick="swLab('completed',this)">âœ… Completed</button>
        <button class="st" onclick="swLab('history',this)">ğŸ“‹ All History</button>
        <button class="st" onclick="swLab('summary',this)">ğŸ“Š Summary</button>
      </div>
      <div class="card"><table id="table-lab"></table></div>
      <div id="lab-entry" class="card" style="display:none;">
        <h4 id="lab-hdr" style="color:var(--p);margin-bottom:9px;"></h4>
        <div id="lab-tests-entry"></div>
        <div class="ab">
          <button onclick="updateLab()" class="bp">Release Results to Doctor</button>
          <button onclick="document.getElementById('lab-entry').style.display='none'" style="background:#e2e8f0;color:#475569;">Cancel</button>
        </div>
      </div>
      <!-- Lab summary panel -->
      <div id="lab-summary-panel" style="display:none;">
        <div class="g2">
          <div class="card"><h4 style="margin-bottom:8px;">ğŸ“Š Lab Test Statistics (This Month)</h4><table id="lab-stats-table"></table></div>
          <div class="card"><h4 style="margin-bottom:8px;">ğŸ† Most Requested Tests</h4><div class="chart-box"><canvas id="ch-lab-stats"></canvas></div></div>
        </div>
      </div>
    </section>

    <!-- PHARMACY -->
    <section id="sec-pharmacy">
      <div class="stabs">
        <button class="st active" onclick="swPharm('pending',this)">ğŸ’Š Pending</button>
        <button class="st" onclick="swPharm('dispensed',this)">âœ… Dispensed History</button>
      </div>
      <div class="card"><table id="table-pharm"></table></div>
    </section>

    <!-- RADIOLOGY -->
    <section id="sec-radiology">
      <div class="stabs">
        <button class="st active" onclick="swRad('pending',this)">ğŸ“¡ Pending</button>
        <button class="st" onclick="swRad('completed',this)">âœ… Completed</button>
        <button class="st" onclick="swRad('history',this)">ğŸ“‹ History</button>
      </div>
      <div class="card"><table id="table-rad"></table></div>
      <div id="rad-entry" class="card" style="display:none;">
        <h4 id="rad-hdr" style="color:var(--pu);margin-bottom:9px;"></h4>
        <div id="rad-tests-entry"></div>
        <div class="ab">
          <button onclick="updateRad()" class="bpu">Release Radiology Results</button>
          <button onclick="document.getElementById('rad-entry').style.display='none'" style="background:#e2e8f0;color:#475569;">Cancel</button>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="sec-inventory">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:7px;">
        <h3>Drug & Supply Inventory</h3>
        <div style="display:flex;gap:6px;">
          <select id="inv-class-filter" onchange="renderInventory()" style="width:auto;margin:0;font-size:12px;"><option value="">All Classes</option></select>
          <select id="inv-cat-filter" onchange="renderInventory()" style="width:auto;margin:0;font-size:12px;"><option value="">All Categories</option></select>
          <button onclick="oModal('inv-add-modal')" class="ba">+ Add / Restock</button>
        </div>
      </div>
      <div class="card" style="padding:9px;"><table id="table-inv"></table></div>
      <div id="inv-add-modal" class="mo">
        <div class="mb" style="max-width:520px;">
          <button class="mc" onclick="cModal('inv-add-modal')">âœ•</button>
          <h3 id="inv-modal-title" style="color:var(--p);margin-bottom:11px;">Add / Restock Item</h3>
          <input type="hidden" id="invEditId">
          <label>Item Name *</label><input id="invName" placeholder="e.g. Amoxicillin 500mg">
          <div class="g2">
            <div><label>Category</label><select id="invCat"><option>Medication</option><option>Consumable</option><option>Equipment</option><option>Reagent</option></select></div>
            <div><label>Drug Class</label><select id="invClass"><option>Antibiotic</option><option>Analgesic</option><option>Analgesic/NSAID</option><option>Opioid Analgesic</option><option>Antimalarial</option><option>Antihypertensive</option><option>Antidiabetic</option><option>Antiparasitic</option><option>Antifungal</option><option>Antiretroviral</option><option>CNS/Neurological</option><option>Cardiovascular</option><option>Cardiovascular/Diuretic</option><option>Corticosteroid</option><option>Gastrointestinal</option><option>Respiratory</option><option>Vitamins &amp; Minerals</option><option>Hormones &amp; Steroids</option><option>IV Fluids &amp; Electrolytes</option><option>Dermatological</option><option>Ophthalmological</option><option>Consumable</option><option>Other</option></select></div>
          </div>
          <div class="g2">
            <div><label>Formulation</label><select id="invForm"><option>Tablet</option><option>Capsule</option><option>Syrup</option><option>Suspension</option><option>Injection (IV)</option><option>Injection (IM)</option><option>Injection (SC)</option><option>IV Fluid</option><option>Cream</option><option>Ointment</option><option>Drops</option><option>Eye Drops</option><option>Ear Drops</option><option>Inhaler</option><option>Suppository</option><option>Powder</option><option>Solution</option><option>Patch</option><option>N/A</option></select></div>
            <div><label>Strength / Concentration</label><input id="invStrength" placeholder="e.g. 500mg, 125mg/5ml"></div>
          </div>
          <div class="g2">
            <div><label>Unit Price ($) *</label><input type="number" id="invPrice" placeholder="0.00" step="0.01" min="0"></div>
            <div><label>Reorder Level</label><input type="number" id="invReorder" placeholder="10" min="0"></div>
          </div>
          <div class="g2">
            <div><label>Add Stock Qty</label><input type="number" id="invQty" placeholder="0" min="0"></div>
            <div><label>Unit</label><select id="invUnit"><option>Tablets</option><option>Capsules</option><option>Vials</option><option>Ampoules</option><option>Bottles</option><option>Sachets</option><option>Strips</option><option>Bags</option><option>Tubes</option><option>Inhalers</option><option>Boxes</option><option>Units</option></select></div>
          </div>
          <div class="g2"><div><label>Batch No.</label><input id="invBatch" placeholder="Optional"></div><div><label>Expiry Date</label><input type="month" id="invExpiry"></div></div>
          <label>Supplier</label><input id="invSupplier" placeholder="Optional">
          <div class="ab"><button onclick="saveInvItem()" class="ba">Save</button><button onclick="cModal('inv-add-modal')" style="background:#e2e8f0;color:#475569;">Cancel</button></div>
        </div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section id="sec-expenses">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:7px;">
        <h3>Expense Management</h3>
        <button onclick="oModal('exp-modal')" class="bp">+ Log Expense</button>
      </div>
      <div class="stabs">
        <button class="st active" onclick="fExp('all',this)">All</button>
        <button class="st" onclick="fExp('today',this)">Today</button>
        <button class="st" onclick="fExp('week',this)">This Week</button>
        <button class="st" onclick="fExp('month',this)">This Month</button>
      </div>
      <div class="card" style="padding:9px;"><table id="table-exp"></table></div>
      <div id="exp-modal" class="mo">
        <div class="mb" style="max-width:480px;">
          <button class="mc" onclick="cModal('exp-modal')">âœ•</button>
          <h3 style="color:var(--p);margin-bottom:11px;">Log Expense</h3>
          <div class="g2">
            <div><label>Date</label><input type="date" id="expDate"></div>
            <div><label>Category</label><select id="expCat"><option>Staff/Salaries</option><option>Supplies/Consumables</option><option>Drugs/Stock Purchase</option><option>Utilities</option><option>Equipment</option><option>Maintenance</option><option>Rent</option><option>Transport</option><option>Marketing</option><option>Other</option></select></div>
          </div>
          <label>Description *</label><input id="expDesc" placeholder="Brief description">
          <label>Amount ($) *</label><input type="number" id="expAmt" placeholder="0.00" step="0.01" min="0">
          <label>Reference / Receipt No.</label><input id="expRef" placeholder="Optional">
          <div class="ab"><button onclick="saveExpense()" class="bp">Save Expense</button><button onclick="cModal('exp-modal')" style="background:#e2e8f0;color:#475569;">Cancel</button></div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="sec-admin">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:7px;">
        <h3>Staff & Access Management</h3>
        <button onclick="oStaffModal(null)" class="bp">+ Add Staff</button>
      </div>
      <div class="card" style="padding:9px;"><table id="table-staff"></table></div>
      <div id="staff-modal" class="mo">
        <div class="mb" style="max-width:560px;">
          <button class="mc" onclick="cModal('staff-modal')">âœ•</button>
          <h3 id="staff-modal-title" style="color:var(--p);margin-bottom:11px;"></h3>
          <input type="hidden" id="staffEid">
          <div class="g2"><div><label>Full Name *</label><input id="staffName"></div><div><label>Username *</label><input id="staffUser"></div></div>
          <label>Password *</label><input type="password" id="staffPass">
          <hr class="dv">
          <p style="font-size:11px;font-weight:700;color:var(--mu);text-transform:uppercase;margin-bottom:7px;">Section Access</p>
          <div id="sec-checks" style="display:flex;flex-wrap:wrap;gap:7px;"></div>
          <div style="margin-top:8px;"><label style="display:inline-flex;align-items:center;gap:5px;cursor:pointer;text-transform:none;font-size:13px;"><input type="checkbox" id="staffAdmin" style="width:auto;margin:0;"> Grant full Admin / Director access</label></div>
          <div class="ab"><button onclick="saveStaff()" class="bp">Save</button><button onclick="cModal('staff-modal')" style="background:#e2e8f0;color:#475569;">Cancel</button></div>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- MODALS -->
<div id="edit-modal" class="mo">
  <div class="mb"><button class="mc" onclick="cModal('edit-modal')">âœ•</button>
    <h3 style="color:var(--p);margin-bottom:11px;">Edit Patient</h3>
    <input type="hidden" id="editPid">
    <div class="g"><div><label>Full Name</label><input id="eName"></div><div><label>Gender</label><select id="eGender"><option>Male</option><option>Female</option></select></div><div><label>Age</label><div style="display:flex;gap:5px;margin-top:2px;"><input type="number" id="eAgeVal" min="0" style="width:55%;margin:0;"><select id="eAgeUnit" style="width:45%;margin:0;"><option value="years">Years</option><option value="months">Months</option><option value="days">Days</option></select></div></div><div><label>Phone</label><input id="ePhone"></div><div><label>Address</label><input id="eAddress"></div><div><label>Kin Name</label><input id="eKin"></div><div><label>Kin Phone</label><input id="eKinP"></div></div>
    <div class="ab"><button onclick="saveEditPat()" class="bp">Save</button><button onclick="cModal('edit-modal')" style="background:#e2e8f0;color:#475569;">Cancel</button></div>
  </div>
</div>

<div id="chart-modal" class="mo">
  <div class="mb" style="max-width:920px;">
    <button class="mc" onclick="cModal('chart-modal')">âœ•</button>
    <h3 id="cm-title" style="color:var(--p);margin-bottom:9px;"></h3>
    <div id="cm-info" style="background:var(--lt);border-radius:6px;padding:10px;margin-bottom:12px;font-size:13px;"></div>
    <div id="cm-visits"></div>
  </div>
</div>

<div id="admit-modal" class="mo">
  <div class="mb" style="max-width:480px;">
    <button class="mc" onclick="cModal('admit-modal')">âœ•</button>
    <h3 style="color:var(--pu);margin-bottom:11px;">ğŸ› Admit Patient</h3>
    <label>Ward / Bed</label><input id="admitWard" placeholder="e.g. Ward A, Bed 3">
    <label>Admission Notes</label><textarea id="admitNotes" rows="3"></textarea>
    <div class="ab"><button onclick="confAdmit()" class="bpu">Confirm Admission</button><button onclick="cModal('admit-modal')" style="background:#e2e8f0;color:#475569;">Cancel</button></div>
  </div>
</div>

<!-- PRINT AREA -->
<div id="pra">
  <div style="text-align:center;margin-bottom:12px;border-bottom:2px solid #000;padding-bottom:9px;">
    <h2 style="margin:0;">TALI MEDICALS</h2><p style="margin:2px 0;font-size:12px;" id="pra-sub"></p>
  </div>
  <div id="pra-con"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JSONBIN CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BIN='699dc1d7d0ea881f40d54dda';
const MK='$2a$10$/RkDKKb/8kctJ9XHGk2vOu2a2V8gyhnUKqscxPOQjPj.Y5CL2Etqa';
const API=`https://api.jsonbin.io/v3/b/${BIN}`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WHO ESSENTIAL MEDICINES + FORMULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WHO_MEDS=[
  // ANTIBIOTICS
  {name:'Amoxicillin',strength:'250mg',formulation:'Capsule',drugClass:'Antibiotic',price:.15,unit:'Capsules',reorderLevel:50,stock:60},
  {name:'Amoxicillin',strength:'500mg',formulation:'Capsule',drugClass:'Antibiotic',price:.20,unit:'Capsules',reorderLevel:50,stock:80},
  {name:'Amoxicillin',strength:'125mg/5ml',formulation:'Syrup',drugClass:'Antibiotic',price:2.50,unit:'Bottles',reorderLevel:20,stock:25},
  {name:'Ampicillin',strength:'500mg',formulation:'Injection (IV)',drugClass:'Antibiotic',price:1.50,unit:'Vials',reorderLevel:20,stock:30},
  {name:'Ciprofloxacin',strength:'500mg',formulation:'Tablet',drugClass:'Antibiotic',price:.25,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Ciprofloxacin',strength:'200mg/100ml',formulation:'Injection (IV)',drugClass:'Antibiotic',price:3.50,unit:'Bottles',reorderLevel:10,stock:15},
  {name:'Metronidazole',strength:'200mg',formulation:'Tablet',drugClass:'Antibiotic',price:.12,unit:'Tablets',reorderLevel:50,stock:80},
  {name:'Metronidazole',strength:'500mg/100ml',formulation:'Injection (IV)',drugClass:'Antibiotic',price:2.00,unit:'Bottles',reorderLevel:15,stock:20},
  {name:'Doxycycline',strength:'100mg',formulation:'Capsule',drugClass:'Antibiotic',price:.18,unit:'Capsules',reorderLevel:30,stock:40},
  {name:'Azithromycin',strength:'500mg',formulation:'Tablet',drugClass:'Antibiotic',price:.80,unit:'Tablets',reorderLevel:20,stock:30},
  {name:'Cotrimoxazole',strength:'480mg',formulation:'Tablet',drugClass:'Antibiotic',price:.10,unit:'Tablets',reorderLevel:50,stock:100},
  {name:'Erythromycin',strength:'500mg',formulation:'Tablet',drugClass:'Antibiotic',price:.30,unit:'Tablets',reorderLevel:30,stock:40},
  {name:'Clindamycin',strength:'150mg',formulation:'Capsule',drugClass:'Antibiotic',price:.50,unit:'Capsules',reorderLevel:20,stock:25},
  {name:'Benzylpenicillin',strength:'1MU',formulation:'Injection (IM)',drugClass:'Antibiotic',price:1.20,unit:'Vials',reorderLevel:20,stock:25},
  // ANALGESICS
  {name:'Paracetamol',strength:'500mg',formulation:'Tablet',drugClass:'Analgesic',price:.05,unit:'Tablets',reorderLevel:100,stock:200},
  {name:'Paracetamol',strength:'120mg/5ml',formulation:'Syrup',drugClass:'Analgesic',price:1.50,unit:'Bottles',reorderLevel:30,stock:40},
  {name:'Ibuprofen',strength:'400mg',formulation:'Tablet',drugClass:'Analgesic/NSAID',price:.08,unit:'Tablets',reorderLevel:50,stock:100},
  {name:'Aspirin',strength:'300mg',formulation:'Tablet',drugClass:'Analgesic/NSAID',price:.05,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Diclofenac',strength:'50mg',formulation:'Tablet',drugClass:'Analgesic/NSAID',price:.12,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Diclofenac',strength:'75mg/3ml',formulation:'Injection (IM)',drugClass:'Analgesic/NSAID',price:.80,unit:'Ampoules',reorderLevel:20,stock:30},
  {name:'Tramadol',strength:'50mg',formulation:'Capsule',drugClass:'Opioid Analgesic',price:.40,unit:'Capsules',reorderLevel:20,stock:30},
  // ANTIMALARIALS
  {name:'Artemether+Lumefantrine',strength:'20/120mg',formulation:'Tablet',drugClass:'Antimalarial',price:3.50,unit:'Strips',reorderLevel:20,stock:30},
  {name:'Artesunate',strength:'60mg',formulation:'Injection (IV)',drugClass:'Antimalarial',price:4.00,unit:'Vials',reorderLevel:10,stock:15},
  {name:'Quinine',strength:'300mg',formulation:'Tablet',drugClass:'Antimalarial',price:.20,unit:'Tablets',reorderLevel:20,stock:40},
  {name:'Quinine',strength:'600mg/2ml',formulation:'Injection (IV)',drugClass:'Antimalarial',price:2.50,unit:'Ampoules',reorderLevel:10,stock:15},
  {name:'Chloroquine',strength:'150mg',formulation:'Tablet',drugClass:'Antimalarial',price:.15,unit:'Tablets',reorderLevel:20,stock:30},
  // ANTIHYPERTENSIVES
  {name:'Amlodipine',strength:'5mg',formulation:'Tablet',drugClass:'Antihypertensive',price:.15,unit:'Tablets',reorderLevel:30,stock:60},
  {name:'Amlodipine',strength:'10mg',formulation:'Tablet',drugClass:'Antihypertensive',price:.20,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Lisinopril',strength:'5mg',formulation:'Tablet',drugClass:'Antihypertensive',price:.18,unit:'Tablets',reorderLevel:30,stock:60},
  {name:'Atenolol',strength:'50mg',formulation:'Tablet',drugClass:'Antihypertensive',price:.12,unit:'Tablets',reorderLevel:30,stock:60},
  {name:'Nifedipine',strength:'10mg',formulation:'Tablet',drugClass:'Antihypertensive',price:.10,unit:'Tablets',reorderLevel:30,stock:60},
  {name:'Hydrochlorothiazide',strength:'25mg',formulation:'Tablet',drugClass:'Antihypertensive',price:.08,unit:'Tablets',reorderLevel:30,stock:60},
  {name:'Methyldopa',strength:'250mg',formulation:'Tablet',drugClass:'Antihypertensive',price:.20,unit:'Tablets',reorderLevel:20,stock:30},
  // ANTIDIABETICS
  {name:'Metformin',strength:'500mg',formulation:'Tablet',drugClass:'Antidiabetic',price:.10,unit:'Tablets',reorderLevel:50,stock:80},
  {name:'Glibenclamide',strength:'5mg',formulation:'Tablet',drugClass:'Antidiabetic',price:.12,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Insulin Regular',strength:'100IU/ml',formulation:'Injection (SC)',drugClass:'Antidiabetic',price:8.00,unit:'Vials',reorderLevel:10,stock:15},
  {name:'Insulin NPH',strength:'100IU/ml',formulation:'Injection (SC)',drugClass:'Antidiabetic',price:8.00,unit:'Vials',reorderLevel:10,stock:10},
  // ANTIPARASITICS
  {name:'Albendazole',strength:'400mg',formulation:'Tablet',drugClass:'Antiparasitic',price:.20,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Mebendazole',strength:'100mg',formulation:'Tablet',drugClass:'Antiparasitic',price:.15,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Praziquantel',strength:'600mg',formulation:'Tablet',drugClass:'Antiparasitic',price:.80,unit:'Tablets',reorderLevel:15,stock:20},
  {name:'Ivermectin',strength:'3mg',formulation:'Tablet',drugClass:'Antiparasitic',price:.50,unit:'Tablets',reorderLevel:20,stock:30},
  // GI
  {name:'Omeprazole',strength:'20mg',formulation:'Capsule',drugClass:'Gastrointestinal',price:.12,unit:'Capsules',reorderLevel:50,stock:80},
  {name:'Ranitidine',strength:'150mg',formulation:'Tablet',drugClass:'Gastrointestinal',price:.10,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Metoclopramide',strength:'10mg',formulation:'Tablet',drugClass:'Gastrointestinal',price:.10,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'ORS Sachets',strength:'Standard',formulation:'Powder',drugClass:'Gastrointestinal',price:.30,unit:'Sachets',reorderLevel:50,stock:80},
  {name:'Loperamide',strength:'2mg',formulation:'Capsule',drugClass:'Gastrointestinal',price:.15,unit:'Capsules',reorderLevel:20,stock:30},
  // RESPIRATORY
  {name:'Salbutamol',strength:'100mcg/dose',formulation:'Inhaler',drugClass:'Respiratory',price:3.50,unit:'Inhalers',reorderLevel:10,stock:15},
  {name:'Salbutamol',strength:'2mg',formulation:'Tablet',drugClass:'Respiratory',price:.08,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Prednisolone',strength:'5mg',formulation:'Tablet',drugClass:'Corticosteroid',price:.08,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Dexamethasone',strength:'4mg/ml',formulation:'Injection (IV)',drugClass:'Corticosteroid',price:1.00,unit:'Ampoules',reorderLevel:15,stock:20},
  {name:'Aminophylline',strength:'250mg/10ml',formulation:'Injection (IV)',drugClass:'Respiratory',price:1.50,unit:'Ampoules',reorderLevel:10,stock:15},
  // VITAMINS
  {name:'Folic Acid',strength:'5mg',formulation:'Tablet',drugClass:'Vitamins & Minerals',price:.03,unit:'Tablets',reorderLevel:100,stock:200},
  {name:'Ferrous Sulfate',strength:'200mg',formulation:'Tablet',drugClass:'Vitamins & Minerals',price:.05,unit:'Tablets',reorderLevel:100,stock:150},
  {name:'Vitamin A',strength:'200,000IU',formulation:'Capsule',drugClass:'Vitamins & Minerals',price:.10,unit:'Capsules',reorderLevel:30,stock:50},
  {name:'Zinc Sulfate',strength:'20mg',formulation:'Tablet',drugClass:'Vitamins & Minerals',price:.05,unit:'Tablets',reorderLevel:50,stock:80},
  // ANTIFUNGALS
  {name:'Fluconazole',strength:'150mg',formulation:'Capsule',drugClass:'Antifungal',price:.80,unit:'Capsules',reorderLevel:20,stock:30},
  {name:'Clotrimazole',strength:'1%',formulation:'Cream',drugClass:'Antifungal',price:1.50,unit:'Tubes',reorderLevel:15,stock:20},
  {name:'Nystatin',strength:'100,000IU',formulation:'Drops',drugClass:'Antifungal',price:2.00,unit:'Bottles',reorderLevel:10,stock:15},
  // CNS
  {name:'Diazepam',strength:'5mg',formulation:'Tablet',drugClass:'CNS/Neurological',price:.15,unit:'Tablets',reorderLevel:20,stock:30},
  {name:'Diazepam',strength:'10mg/2ml',formulation:'Injection (IV)',drugClass:'CNS/Neurological',price:1.00,unit:'Ampoules',reorderLevel:10,stock:15},
  {name:'Phenobarbitone',strength:'30mg',formulation:'Tablet',drugClass:'CNS/Neurological',price:.10,unit:'Tablets',reorderLevel:20,stock:30},
  {name:'Carbamazepine',strength:'200mg',formulation:'Tablet',drugClass:'CNS/Neurological',price:.20,unit:'Tablets',reorderLevel:20,stock:30},
  {name:'Haloperidol',strength:'5mg',formulation:'Tablet',drugClass:'CNS/Neurological',price:.25,unit:'Tablets',reorderLevel:15,stock:25},
  // CARDIOVASCULAR
  {name:'Digoxin',strength:'0.25mg',formulation:'Tablet',drugClass:'Cardiovascular',price:.20,unit:'Tablets',reorderLevel:20,stock:30},
  {name:'Furosemide',strength:'40mg',formulation:'Tablet',drugClass:'Cardiovascular/Diuretic',price:.10,unit:'Tablets',reorderLevel:30,stock:50},
  {name:'Furosemide',strength:'20mg/2ml',formulation:'Injection (IV)',drugClass:'Cardiovascular/Diuretic',price:.80,unit:'Ampoules',reorderLevel:15,stock:20},
  {name:'Spironolactone',strength:'25mg',formulation:'Tablet',drugClass:'Cardiovascular/Diuretic',price:.20,unit:'Tablets',reorderLevel:20,stock:30},
  // HORMONES
  {name:'Hydrocortisone',strength:'100mg',formulation:'Injection (IV)',drugClass:'Hormones & Steroids',price:1.50,unit:'Vials',reorderLevel:10,stock:15},
  {name:'Oxytocin',strength:'10IU/ml',formulation:'Injection (IM)',drugClass:'Hormones & Steroids',price:.80,unit:'Ampoules',reorderLevel:15,stock:20},
  {name:'Magnesium Sulfate',strength:'50%/10ml',formulation:'Injection (IV)',drugClass:'Hormones & Steroids',price:1.00,unit:'Ampoules',reorderLevel:10,stock:15},
  // IV FLUIDS
  {name:'Normal Saline 0.9%',strength:'500ml',formulation:'IV Fluid',drugClass:'IV Fluids & Electrolytes',price:2.00,unit:'Bags',reorderLevel:20,stock:30},
  {name:'Dextrose 5%',strength:'500ml',formulation:'IV Fluid',drugClass:'IV Fluids & Electrolytes',price:2.00,unit:'Bags',reorderLevel:20,stock:30},
  {name:"Ringer's Lactate",strength:'500ml',formulation:'IV Fluid',drugClass:'IV Fluids & Electrolytes',price:2.50,unit:'Bags',reorderLevel:20,stock:25},
  {name:'Water for Injection',strength:'10ml',formulation:'Injection (IV)',drugClass:'IV Fluids & Electrolytes',price:.30,unit:'Ampoules',reorderLevel:30,stock:50},
];

const LAB_TESTS=[
  {name:'Malaria RDT',price:5},{name:'Full Blood Count',price:15},{name:'Urinalysis',price:6},
  {name:'Blood Glucose (RBS)',price:4},{name:'Liver Function Test',price:20},{name:'Pregnancy Test',price:3},
  {name:'Widal Test',price:8},{name:'HIV Screening',price:5},{name:'Lipid Profile',price:18},
  {name:'Renal Function Test',price:18},{name:'Hepatitis B (HBsAg)',price:10},{name:'Blood Culture & Sensitivity',price:25},
  {name:'Stool MCS',price:8},{name:'Urine MCS',price:10},{name:'Thyroid Function (TFT)',price:22},
  {name:'ESR',price:6},{name:'Malaria Thick Film',price:8},{name:'Blood Group & Crossmatch',price:12},
  {name:'Serum Electrolytes',price:15},{name:'Blood Urea Nitrogen',price:12},{name:'Serum Creatinine',price:12},
  {name:'Serum Uric Acid',price:10},{name:'CD4 Count',price:25},{name:'Hepatitis C Antibody',price:10},
  {name:'Sputum AFB',price:10},{name:'Prothrombin Time',price:15},{name:'HbA1c',price:20},
];

const RADIOLOGY_PROCS=[
  {name:'Chest X-Ray',price:20},{name:'Abdominal X-Ray',price:20},{name:'Skull X-Ray',price:20},
  {name:'Spine X-Ray',price:25},{name:'Pelvis X-Ray',price:22},{name:'Limb X-Ray',price:18},
  {name:'Abdominal Ultrasound',price:35},{name:'Pelvic Ultrasound',price:35},{name:'Obstetric Ultrasound',price:40},
  {name:'Scrotal Ultrasound',price:30},{name:'Neck/Thyroid Ultrasound',price:30},{name:'Cardiac Echo',price:60},
  {name:'Doppler Ultrasound',price:50},{name:'CT Scan Head',price:120},{name:'CT Scan Chest',price:130},
  {name:'CT Scan Abdomen',price:140},{name:'MRI Brain',price:200},{name:'MRI Spine',price:200},
  {name:'Mammography',price:50},{name:'ECG',price:15},{name:'Spirometry',price:20},{name:'Peak Flow',price:5},
  {name:'EEG',price:60},{name:'DEXA Scan',price:80},
];

const DOSAGE_OPTS=[
  'Once daily (OD)','Twice daily (BD)','Three times daily (TDS)','Four times daily (QDS)',
  'Every 8 hours','Every 6 hours','Every 12 hours','At night (nocte)','As needed (PRN)',
  'Stat (single dose)','Every other day','Once weekly','Before meals','After meals','With meals','Stat then OD',
];

const ALL_SECS=['reception','nurse','doctor','billing','lab','pharmacy','radiology','inventory','expenses'];
const SEC_LABELS={reception:'Reception',nurse:'Nurse',doctor:'Doctor',billing:'Billing',lab:'Lab',pharmacy:'Pharmacy',radiology:'Radiology',inventory:'Inventory',expenses:'Expenses'};
const CONSULT_FEE=10;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let patients=[],visits=[],inventory=[],staffList=[],expenses=[];
let currentUser=null,activeVid=null,activePayVid=null;
let radRowId=0,medRowId=0,radRows=[],medRows=[];
let billFilter='all',labTab='pending',pharmTab='pending',radTab='pending',expFilter='all';
let saveTimer=null,charts={};
let selectedLabTests=new Set();
let allLabTests=[...LAB_TESTS];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JSONBIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData(){
  try{
    const r=await fetch(`${API}/latest`,{headers:{'X-Master-Key':MK}});
    const j=await r.json();const d=j.record||{};
    patients  = d.patients  ||[];
    visits    = d.visits    ||[];
    inventory = (d.inventory&&d.inventory.length)?d.inventory:initInv();
    staffList = (d.staffList&&d.staffList.length)?d.staffList:initStaff();
    expenses  = d.expenses  ||[];
  }catch(e){
    console.warn('JSONBin load failed:',e);
    patients=[];visits=[];expenses=[];
    inventory=initInv();staffList=initStaff();
  }
}

function initInv(){
  return WHO_MEDS.map((m,i)=>({
    id:'I-W'+String(i).padStart(3,'0'),
    name:m.name,category:m.formulation.startsWith('IV')||m.formulation.startsWith('Injection')?'Medication':'Medication',
    drugClass:m.drugClass,formulation:m.formulation,strength:m.strength,
    stock:m.stock||30,unit:m.unit,price:m.price,reorderLevel:m.reorderLevel||10,history:[]
  }));
}

function initStaff(){
  return[
    {id:'S1',name:'Dr. Admin Director',username:'director',  password:'dir123', sections:[...ALL_SECS],isAdmin:true},
    {id:'S2',name:'Mary Asante',       username:'reception1',password:'rec123', sections:['reception'],isAdmin:false},
    {id:'S3',name:'Nurse Comfort',     username:'nurse1',    password:'nur123', sections:['nurse','reception'],isAdmin:false},
    {id:'S4',name:'Dr. Kwame Mensah',  username:'doctor1',   password:'doc123', sections:['doctor','reception'],isAdmin:false},
    {id:'S5',name:'Ama Billing',       username:'billing1',  password:'bil123', sections:['billing'],isAdmin:false},
    {id:'S6',name:'Kofi Lab Tech',     username:'lab1',      password:'lab123', sections:['lab'],isAdmin:false},
    {id:'S7',name:'Esi Pharmacist',    username:'pharmacy1', password:'pha123', sections:['pharmacy','inventory'],isAdmin:false},
  ];
}

function save(){
  if(saveTimer)clearTimeout(saveTimer);
  si('Savingâ€¦');
  saveTimer=setTimeout(async()=>{
    try{
      await fetch(API,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':MK,'X-Bin-Versioning':'false'},body:JSON.stringify({patients,visits,inventory,staffList,expenses})});
      si('Saved âœ“',true);
    }catch(e){si('Save failed âœ—');}
  },1200);
}
function si(t,ok){const el=document.getElementById('si3');if(el){el.innerText=t;el.style.opacity=ok?.6:1;}}
function lg(v,act,val=''){if(!v.timeline)v.timeline=[];v.timeline.push({act,val,time:new Date().toLocaleTimeString(),by:currentUser?.name||'System'});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',async()=>{
  await loadData();
  document.getElementById('ls').style.display='none';
  document.getElementById('lp').style.display='flex';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function login(){
  const u=document.getElementById('lu').value.trim();
  const p=document.getElementById('lp2').value;
  const s=staffList.find(x=>x.username===u&&x.password===p);
  if(!s){document.getElementById('le').innerText='Invalid credentials.';return;}
  currentUser=s;
  document.getElementById('lp').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('du').innerText=`${s.name}`;
  renderNav();showSection(s.isAdmin?'director':(s.sections[0]||'reception'));
}

function renderNav(){
  const secs=currentUser.isAdmin?['director',...ALL_SECS,'admin']:(currentUser.sections||[]);
  const lbl={director:'Dashboard',...SEC_LABELS,admin:'Admin'};
  document.getElementById('dn').innerHTML=secs.map(s=>`<button id="btn-${s}" class="nb" onclick="showSection('${s}')">${lbl[s]||s.toUpperCase()}</button>`).join('');
}

function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('active'));
  document.getElementById('sec-'+id)?.classList.add('active');
  document.getElementById('btn-'+id)?.classList.add('active');
  ({
    director:renderDash,reception:renderPatients,
    nurse:()=>{renderTriage();renderTreatList();},
    doctor:renderCons,billing:()=>renderBilling(),
    lab:()=>renderLab(),pharmacy:()=>renderPharm(),
    radiology:()=>renderRad(),inventory:renderInventory,
    expenses:()=>renderExpenses(),admin:renderAdmin
  })[id]?.();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DIRECTOR DASHBOARD + CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash(){
  const today=new Date().toLocaleDateString();
  const tv=visits.filter(v=>v.date===today);
  const rev=tv.reduce((s,v)=>s+v.totalPaid,0);
  const exp=expenses.filter(e=>e.date===today).reduce((s,e)=>s+e.amount,0);
  const debt=visits.reduce((s,v)=>{const b=totalBill(v);return s+(b-v.totalPaid);},0);
  const sval=inventory.reduce((s,i)=>s+(i.stock*i.price),0);
  const labsToday=tv.reduce((s,v)=>s+(v.labs||[]).filter(l=>l.name).length,0);
  document.getElementById('d-rev').innerText='$'+rev.toFixed(2);
  document.getElementById('d-exp').innerText='$'+exp.toFixed(2);
  document.getElementById('d-pats').innerText=tv.length;
  document.getElementById('d-debt').innerText='$'+Math.max(0,debt).toFixed(2);
  document.getElementById('d-stock-val').innerText='$'+sval.toFixed(2);
  document.getElementById('d-adm').innerText=visits.filter(v=>v.status==='ADMITTED').length;
  document.getElementById('d-labs').innerText=labsToday;
  document.getElementById('d-disc').innerText=tv.filter(v=>v.status==='DISCHARGED').length;
  buildRevExpChart();buildVisitsChart();buildDebtChart();buildLabChart();
  buildStockValTable();buildLowStockTable();
}

function getLast7Days(){
  const days=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days.push(d.toLocaleDateString());}return days;
}
function getThisMonth(){
  const days=[];const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const total=new Date(year,month+1,0).getDate();
  for(let i=1;i<=total;i++){const d=new Date(year,month,i);days.push(d.toLocaleDateString());}return days;
}
function dChart(k){if(charts[k]){charts[k].destroy();delete charts[k];}}

function buildRevExpChart(){
  dChart('revexp');const ctx=document.getElementById('ch-revexp');if(!ctx)return;
  const days=getLast7Days();
  const revData=days.map(d=>visits.filter(v=>v.date===d).reduce((s,v)=>s+v.totalPaid,0));
  const expData=days.map(d=>expenses.filter(e=>e.date===d).reduce((s,e)=>s+e.amount,0));
  const labels=days.map(d=>{const p=d.split('/');return p[1]+'/'+p[0];});
  charts.revexp=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Revenue',data:revData,backgroundColor:'rgba(16,185,129,.7)'},{label:'Expenses',data:expData,backgroundColor:'rgba(239,68,68,.7)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}});
}

function buildVisitsChart(){
  dChart('visits');const ctx=document.getElementById('ch-visits');if(!ctx)return;
  const days=getThisMonth();const counts=days.map(d=>visits.filter(v=>v.date===d).length);
  const labels=days.map(d=>{const p=d.split('/');return p[1];});
  charts.visits=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Patients',data:counts,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',tension:.3,fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});
}

function buildDebtChart(){
  dChart('debt');const ctx=document.getElementById('ch-debt');if(!ctx)return;
  const total=visits.reduce((s,v)=>s+totalBill(v),0);
  const paid=visits.reduce((s,v)=>s+v.totalPaid,0);
  const unpaid=Math.max(0,total-paid);
  charts.debt=new Chart(ctx,{type:'doughnut',data:{labels:['Collected','Outstanding'],datasets:[{data:[paid,unpaid],backgroundColor:['#10b981','#ef4444'],borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  document.getElementById('debt-legend').innerHTML=`<div style="margin-bottom:6px;"><span style="display:inline-block;width:12px;height:12px;background:#10b981;border-radius:2px;margin-right:5px;"></span>Collected: <b>$${paid.toFixed(2)}</b></div><div><span style="display:inline-block;width:12px;height:12px;background:#ef4444;border-radius:2px;margin-right:5px;"></span>Outstanding: <b>$${unpaid.toFixed(2)}</b></div><hr style="margin:8px 0;"><div>Total Billed: <b>$${total.toFixed(2)}</b></div><div style="margin-top:4px;">Recovery Rate: <b>${total>0?((paid/total)*100).toFixed(1):0}%</b></div>`;
}

function buildLabChart(){
  dChart('labch');const ctx=document.getElementById('ch-lab-stats');if(!ctx)return;
  const now=new Date();const m=now.getMonth();const y=now.getFullYear();
  const monthVisits=visits.filter(v=>{const d=new Date(v.date);return d.getMonth()===m&&d.getFullYear()===y;});
  const counts={};
  monthVisits.forEach(v=>(v.labs||[]).filter(l=>l.name).forEach(l=>{counts[l.name]=(counts[l.name]||0)+1;}));
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  if(!sorted.length)return;
  charts.labch=new Chart(ctx,{type:'bar',data:{labels:sorted.map(x=>x[0]),datasets:[{label:'Requests',data:sorted.map(x=>x[1]),backgroundColor:'rgba(124,58,237,.7)'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{stepSize:1}}}}});
}

function buildStockValTable(){
  const cats={};
  inventory.forEach(i=>{const c=i.drugClass||'Other';cats[c]=(cats[c]||0)+i.stock*i.price;});
  let h=`<tr><th>Drug Class</th><th>Value ($)</th></tr>`;
  Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([c,v])=>h+=`<tr><td>${c}</td><td><b>$${v.toFixed(2)}</b></td></tr>`);
  document.getElementById('d-stockval').innerHTML=h;
}
function buildLowStockTable(){
  const low=inventory.filter(i=>i.stock<=i.reorderLevel);
  let h=`<tr><th>Item</th><th>Stock</th><th>Reorder</th></tr>`;
  low.length?low.forEach(i=>h+=`<tr><td>${i.name} ${i.strength||''}</td><td style="color:var(--d);font-weight:700;">${i.stock}</td><td>${i.reorderLevel}</td></tr>`):h+=`<tr><td colspan="3" style="color:var(--a);text-align:center;">All stocked âœ“</td></tr>`;
  document.getElementById('d-lowstock').innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECEPTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newVisit(vId,patId,name,consultType='GENERAL'){
  const statusMap={GENERAL:'WAITING_TRIAGE',LAB_ONLY:'WAITING_LAB',RADIOLOGY:'WAITING_RADIOLOGY',DENTAL:'WAITING_SPECIAL',ENT:'WAITING_SPECIAL',OTHER_SPECIAL:'WAITING_SPECIAL'};
  return{id:vId,patId,name,consultType,status:statusMap[consultType]||'WAITING_TRIAGE',date:new Date().toLocaleDateString(),
    timeline:[],vitals:null,clinical:{pc:'',hpc:'',pmh:'',lmp:'',gravPara:'',obsGyn:'',fsh:'',drugHx:'',allergies:'',diffDx:'',finalDx:'',notes:''},
    labs:[],radiology:[],prescriptions:[],treatmentChart:[],
    consultFee:0,discount:0,discountReason:'',totalPaid:0,payments:[],admitted:false,admissionWard:'',cleared:[]};
}

function registerPatient(){
  const name=document.getElementById('pName').value.trim();
  const ageVal=document.getElementById('pAgeVal').value;
  if(!name||!ageVal)return alert('Enter name and age.');
  const consultType=document.getElementById('pConsultType').value;
  const pId='P-'+Date.now().toString().slice(-7);
  patients.push({id:pId,name,gender:document.getElementById('pGender').value,ageVal:parseInt(ageVal),ageUnit:document.getElementById('pAgeUnit').value,phone:document.getElementById('pPhone').value,address:document.getElementById('pAddress').value,kinName:document.getElementById('pKinName').value,kinPhone:document.getElementById('pKinPhone').value});
  const vId='V-'+Date.now().toString().slice(-7);
  const v=newVisit(vId,pId,name,consultType);
  const note=document.getElementById('pRegNote').value.trim();
  if(note)lg(v,'Registration Note',note);
  lg(v,'Registered',`Type: ${consultType}. By: ${currentUser.name}`);
  visits.push(v);save();renderPatients();
  ['pName','pPhone','pAddress','pKinName','pKinPhone'].forEach(f=>document.getElementById(f).value='');
  document.getElementById('pAgeVal').value='';
  const routeMsg={GENERAL:'â†’ Triage Queue',LAB_ONLY:'â†’ Lab directly',RADIOLOGY:'â†’ Radiology',DENTAL:'â†’ Special (Dental)',ENT:'â†’ Special (ENT)',OTHER_SPECIAL:'â†’ Special Consultation'};
  alert(`${name} registered. ${routeMsg[consultType]||''}`);
}

function renderPatients(){
  const term=(document.getElementById('patSearch')?.value||'').toLowerCase();
  let h=`<tr><th>Name</th><th>Age</th><th>Gender</th><th>Phone</th><th>Last Visit</th><th>Pay Status</th><th>Cleared</th><th>Actions</th></tr>`;
  const f=patients.filter(p=>p.name.toLowerCase().includes(term));
  if(!f.length){h+=`<tr><td colspan="8" class="emp">No patients found</td></tr>`;}
  f.forEach(p=>{
    const pv=visits.filter(v=>v.patId===p.id);const last=pv.length?pv[pv.length-1]:null;
    const chips=last?last.cleared.map(d=>`<span class="dc">${d}</span>`).join(''):'';
    const st=last?`<span class="badge bgr" style="font-size:10px;">${last.status.replace(/_/g,' ')}</span> <span class="consult-type-badge ct-${(last.consultType||'gen').toLowerCase().split('_')[0]}">${last.consultType||'GENERAL'}</span>`:'No visits';
    h+=`<tr><td><b>${p.name}</b></td><td>${p.ageVal} ${p.ageUnit}</td><td>${p.gender}</td><td>${p.phone||'â€”'}</td><td>${st}</td><td>${last?payBadge(last):'â€”'}</td><td>${chips||'<span style="color:#94a3b8;font-size:11px;">None</span>'}</td>
      <td><div style="display:flex;gap:3px;flex-wrap:wrap;">
        <button class="bsm bo" onclick="startVisit('${p.id}','${enc(p.name)}')">+ Visit</button>
        <button class="bsm" style="background:#e2e8f0;color:#475569;" onclick="editPat('${p.id}')">Edit</button>
        <button class="bsm" style="background:var(--s);color:#fff;" onclick="openChart('${p.id}')">Chart</button>
      </div></td></tr>`;
  });
  document.getElementById('table-pats').innerHTML=h;
}

function startVisit(patId,eName){
  const name=dec(eName);
  if(!confirm(`Start new visit for ${name}?`))return;
  const ct=prompt('Consultation type:\n1=General\n2=Lab Only\n3=Radiology\n4=Dental\n5=ENT\n6=Other Special\n(Enter number)','1');
  const map={'1':'GENERAL','2':'LAB_ONLY','3':'RADIOLOGY','4':'DENTAL','5':'ENT','6':'OTHER_SPECIAL'};
  const consultType=map[ct]||'GENERAL';
  const vId='V-'+Date.now().toString().slice(-7);
  const v=newVisit(vId,patId,name,consultType);
  lg(v,'New visit');visits.push(v);save();renderPatients();alert('Queued.');
}

function editPat(pId){
  const p=patients.find(x=>x.id===pId);if(!p)return;
  document.getElementById('editPid').value=pId;
  document.getElementById('eName').value=p.name;
  document.getElementById('eGender').value=p.gender;
  document.getElementById('eAgeVal').value=p.ageVal;
  document.getElementById('eAgeUnit').value=p.ageUnit;
  document.getElementById('ePhone').value=p.phone||'';
  document.getElementById('eAddress').value=p.address||'';
  document.getElementById('eKin').value=p.kinName||'';
  document.getElementById('eKinP').value=p.kinPhone||'';
  oModal('edit-modal');
}
function saveEditPat(){
  const p=patients.find(x=>x.id===document.getElementById('editPid').value);if(!p)return;
  p.name=document.getElementById('eName').value.trim();
  p.gender=document.getElementById('eGender').value;
  p.ageVal=parseInt(document.getElementById('eAgeVal').value);
  p.ageUnit=document.getElementById('eAgeUnit').value;
  p.phone=document.getElementById('ePhone').value;
  p.address=document.getElementById('eAddress').value;
  p.kinName=document.getElementById('eKin').value;
  p.kinPhone=document.getElementById('eKinP').value;
  save();cModal('edit-modal');renderPatients();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATIENT CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openChart(pId){
  const p=patients.find(x=>x.id===pId);if(!p)return;
  document.getElementById('cm-title').innerText=`Patient Chart â€” ${p.name}`;
  document.getElementById('cm-info').innerHTML=`<div class="g" style="gap:7px;"><div><b>Age:</b>${p.ageVal} ${p.ageUnit} | <b>Gender:</b>${p.gender}</div><div><b>Phone:</b>${p.phone||'â€”'} | <b>Address:</b>${p.address||'â€”'}</div><div><b>Next of Kin:</b>${p.kinName||'â€”'} ${p.kinPhone?'/ '+p.kinPhone:''}</div></div>`;
  const pv=visits.filter(v=>v.patId===pId).sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(!pv.length){document.getElementById('cm-visits').innerHTML='<div class="emp">No visits.</div>';oModal('chart-modal');return;}
  document.getElementById('cm-visits').innerHTML=pv.map(v=>{
    const tot=totalBill(v);const bs=billStatus(v);
    const bcls=bs==='PAID'?'bpd':bs==='PARTIAL'?'bpa':'bp2';
    const labItems=(v.labs||[]).filter(l=>l.name).map(l=>`<span class="tag tl">${l.name}${l.done?' âœ“':''}</span>`).join(' ');
    const radItems=(v.radiology||[]).filter(r=>r.name).map(r=>`<span class="tag tr2">${r.name}${r.done?' âœ“':''}</span>`).join(' ');
    const rxItems=(v.prescriptions||[]).filter(r=>r.name).map(r=>`<span class="tag tm">${r.name} Ã— ${r.qty}</span>`).join(' ');
    const tl=(v.timeline||[]).map(t=>`<div class="ti"><span class="tt">${t.time}</span><div><b>${t.act}</b>${t.val?' â€” <span style="color:#475569;font-size:12px;">'+t.val+'</span>':''} <span class="tb">(${t.by})</span></div></div>`).join('');
    return`<div class="card" style="margin-bottom:9px;border-left:4px solid var(--s);">
      <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:5px;margin-bottom:7px;">
        <b>${v.date}</b><div style="display:flex;gap:4px;align-items:center;">
          <span class="badge ${bcls}" style="font-size:10px;">${bs}</span>
          <span class="badge bgr" style="font-size:10px;">${v.status.replace(/_/g,' ')}</span>
          <button class="bsm bo" onclick="printInvoice('${v.id}')">ğŸ–¨ Invoice</button>
          ${(v.labs||[]).some(l=>l.done)?`<button class="bsm" style="background:var(--a);color:#fff;" onclick="printAllLabs('${v.id}')">ğŸ”¬ Labs PDF</button>`:''}
        </div>
      </div>
      <div style="font-size:12px;margin-bottom:7px;">${labItems} ${radItems} ${rxItems}</div>
      ${tot?`<div style="font-size:12px;margin-bottom:7px;"><b>Bill:$${tot.toFixed(2)} | Paid:$${v.totalPaid.toFixed(2)} | Bal:$${(tot-v.totalPaid).toFixed(2)}</b></div>`:''}
      <div style="font-size:11px;font-weight:700;color:var(--mu);text-transform:uppercase;margin-bottom:4px;">Timeline</div>${tl}
    </div>`;
  }).join('');
  oModal('chart-modal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NURSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function swNurse(tab,btn){
  document.querySelectorAll('#sec-nurse .st').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  document.getElementById('nurse-triage').style.display=tab==='triage'?'block':'none';
  document.getElementById('nurse-treatment').style.display=tab==='treatment'?'block':'none';
  document.getElementById('nurse-reg').style.display=tab==='reg'?'block':'none';
  if(tab==='reg')injectReg('nurse-reg');
  if(tab==='treatment')renderTreatList();
}

function renderTriage(){
  const q=visits.filter(v=>v.status==='WAITING_TRIAGE');
  let h=`<tr><th>Patient</th><th>Age/Gender</th><th>Type</th><th>Date</th><th>Pay Status</th><th>Action</th></tr>`;
  if(!q.length)h+=`<tr><td colspan="6" class="emp">No patients waiting for triage</td></tr>`;
  q.forEach(v=>{const p=patients.find(x=>x.id===v.patId);
    h+=`<tr><td><b>${v.name}</b></td><td>${p?p.ageVal+' '+p.ageUnit+'/'+p.gender:'â€”'}</td><td><span class="consult-type-badge ct-gen">${v.consultType||'GENERAL'}</span></td><td>${v.date}</td><td>${payBadge(v)}</td><td><button onclick="openTriage('${v.id}')">Record Vitals</button></td></tr>`;
  });
  document.getElementById('table-triage').innerHTML=h;
}

function openTriage(id){
  activeVid=id;
  const v=visits.find(x=>x.id===id);
  document.getElementById('triage-target').innerText=`Vitals â€” ${v.name}`;
  ['vBP','vTemp','vWeight','vHeight','vPulse','vSpO2','vRR'].forEach(f=>document.getElementById(f).value='');
  document.getElementById('bmi-display').innerText='Enter weight and height';
  document.getElementById('bmi-val').innerText='';
  document.getElementById('triage-form').style.display='block';
  document.getElementById('triage-form').scrollIntoView({behavior:'smooth'});
}

function calcBMI(){
  const w=parseFloat(document.getElementById('vWeight').value)||0;
  const h=parseFloat(document.getElementById('vHeight').value)||0;
  if(!w||!h)return;
  const bmi=w/((h/100)*(h/100));
  const cat=bmi<18.5?'Underweight':bmi<25?'Normal weight':bmi<30?'Overweight':'Obese';
  const col=bmi<18.5?'#0ea5e9':bmi<25?'#10b981':bmi<30?'#f59e0b':'#ef4444';
  document.getElementById('bmi-display').innerHTML=`BMI: <b style="font-size:16px;color:${col};">${bmi.toFixed(1)}</b> â€” <span class="bmi-badge" style="background:${col}20;color:${col};">${cat}</span>`;
  document.getElementById('bmi-val').innerText=`${bmi.toFixed(1)}`;
}

function submitTriage(){
  const v=visits.find(x=>x.id===activeVid);
  const fields=[['vBP','BP'],['vTemp','Temp'],['vWeight','Wt(kg)'],['vHeight','Ht(cm)'],['vPulse','Pulse'],['vSpO2','SpO2'],['vRR','RR']];
  const parts=fields.map(([id,l])=>{const val=document.getElementById(id).value;return val?`${l}:${val}`:null;}).filter(Boolean);
  const w=parseFloat(document.getElementById('vWeight').value)||0;
  const h=parseFloat(document.getElementById('vHeight').value)||0;
  if(w&&h){const bmi=w/((h/100)*(h/100));const cat=bmi<18.5?'Underweight':bmi<25?'Normal':bmi<30?'Overweight':'Obese';parts.push(`BMI:${bmi.toFixed(1)}(${cat})`);}
  if(!parts.length)return alert('Enter at least one vital sign.');
  v.vitals={bp:document.getElementById('vBP').value,temp:document.getElementById('vTemp').value,weight:document.getElementById('vWeight').value,height:document.getElementById('vHeight').value,pulse:document.getElementById('vPulse').value,spo2:document.getElementById('vSpO2').value,rr:document.getElementById('vRR').value,time:new Date().toLocaleTimeString(),by:currentUser.name};
  lg(v,'Vitals',parts.join(' | '));
  v.status='WAITING_CONSULTATION';
  if(!v.cleared.includes('Triage'))v.cleared.push('Triage');
  save();document.getElementById('triage-form').style.display='none';renderTriage();
}

function renderTreatList(){
  const active=visits.filter(v=>!['DISCHARGED'].includes(v.status));
  let h=`<tr><th>Patient</th><th>Status</th><th>Diagnosis</th><th>Pay Status</th><th>Action</th></tr>`;
  if(!active.length)h+=`<tr><td colspan="5" class="emp">No active patients</td></tr>`;
  active.forEach(v=>{
    const dx=v.clinical?.finalDx||v.clinical?.diffDx||'â€”';
    h+=`<tr><td><b>${v.name}</b></td><td><span class="badge bgr" style="font-size:10px;">${v.status.replace(/_/g,' ')}</span></td><td style="font-size:12px;">${dx}</td><td>${payBadge(v)}</td><td><button onclick="openTreat('${v.id}')">Chart</button></td></tr>`;
  });
  document.getElementById('table-treat-pats').innerHTML=h;
}

function openTreat(id){
  activeVid=id;
  const v=visits.find(x=>x.id===id);
  document.getElementById('treat-name').innerText=`Treatment Chart â€” ${v.name}`;
  const dx=v.clinical?.finalDx||v.clinical?.diffDx||'Not yet set';
  const rxList=(v.prescriptions||[]).map(r=>`<div>ğŸ’Š <b>${r.name}</b> ${r.strength||''} Ã— ${r.qty} â€” ${r.instructions} ${r.dispensed?'âœ…':''}</div>`).join('')||'No prescriptions yet';
  document.getElementById('treat-orders').innerHTML=`<b>Diagnosis:</b> ${dx}<br><b>Prescriptions:</b><br>${rxList}`;
  document.getElementById('tTime').value=new Date().toTimeString().slice(0,5);
  ['tDrug','tDose','tNotes'].forEach(f=>document.getElementById(f).value='');
  renderExistTreats(v);
  document.getElementById('treatment-detail').style.display='block';
  document.getElementById('treatment-detail').scrollIntoView({behavior:'smooth'});
}

function renderExistTreats(v){
  const tc=v.treatmentChart||[];
  const c=document.getElementById('existing-treats');
  if(!tc.length){c.innerHTML='<div class="emp">No entries yet.</div>';return;}
  c.innerHTML='<h5 style="margin-bottom:7px;font-size:11px;text-transform:uppercase;color:var(--mu);">Previous Entries</h5>'+
    tc.map(e=>`<div style="background:var(--lt);border-left:3px solid var(--a);padding:7px 11px;border-radius:5px;margin-bottom:5px;font-size:12px;">
      <div style="display:flex;justify-content:space-between;"><b>${e.drug} â€” ${e.dose} (${e.route})</b><span style="color:var(--mu);">${e.time}</span></div>
      ${e.notes?`<div style="color:#475569;margin-top:2px;">${e.notes}</div>`:''}
      <div class="tb">By: ${e.by}</div></div>`).join('');
}

function addTreatEntry(){
  const v=visits.find(x=>x.id===activeVid);
  const drug=document.getElementById('tDrug').value.trim();
  const dose=document.getElementById('tDose').value.trim();
  if(!drug||!dose)return alert('Enter drug and dose.');
  if(!v.treatmentChart)v.treatmentChart=[];
  v.treatmentChart.push({drug,dose,route:document.getElementById('tRoute').value,time:document.getElementById('tTime').value||new Date().toLocaleTimeString(),notes:document.getElementById('tNotes').value.trim(),by:currentUser.name,date:new Date().toLocaleDateString()});
  lg(v,'Treatment',`${drug} ${dose} ${document.getElementById('tRoute').value}`);
  save();renderExistTreats(v);
  ['tDrug','tDose','tNotes'].forEach(f=>document.getElementById(f).value='');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOCTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function swDoc(tab,btn){
  document.querySelectorAll('#sec-doctor .st').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  document.getElementById('doc-queue').style.display=tab==='queue'?'block':'none';
  document.getElementById('doc-allpats').style.display=tab==='allpats'?'block':'none';
  document.getElementById('doc-reg').style.display=tab==='reg'?'block':'none';
  if(tab==='reg')injectReg('doc-reg');
  if(tab==='allpats')renderAllPats();
}

function renderCons(){
  const q=visits.filter(v=>!['DISCHARGED','ADMITTED'].includes(v.status));
  let h=`<tr><th>Patient</th><th>Age/Gender</th><th>Type</th><th>Status</th><th>Pay</th><th>Labs</th><th>Rad</th><th>Rx</th><th>Action</th></tr>`;
  if(!q.length)h+=`<tr><td colspan="9" class="emp">No active patients</td></tr>`;
  q.forEach(v=>{
    const p=patients.find(x=>x.id===v.patId);
    const info=p?`${p.ageVal}${p.ageUnit[0]}/${p.gender}`:'â€”';
    const lc=(v.labs||[]).length,ld=(v.labs||[]).filter(l=>l.done).length;
    const rc=(v.radiology||[]).length,rd=(v.radiology||[]).filter(r=>r.done).length;
    const rxc=(v.prescriptions||[]).length,rxd=(v.prescriptions||[]).filter(r=>r.dispensed).length;
    const bcls=v.status==='LAB_READY'||v.status==='RAD_READY'?'bgn':v.status==='WAITING_CONSULTATION'?'bbl':'bgr';
    const ctClass={GENERAL:'ct-gen',LAB_ONLY:'ct-lab',RADIOLOGY:'ct-rad',DENTAL:'ct-spc',ENT:'ct-spc',OTHER_SPECIAL:'ct-spc'}[v.consultType]||'ct-gen';
    h+=`<tr><td><b>${v.name}</b></td><td>${info}</td><td><span class="consult-type-badge ${ctClass}">${v.consultType||'GEN'}</span></td><td><span class="badge ${bcls}" style="font-size:10px;">${v.status.replace(/_/g,' ')}</span></td><td>${payBadge(v)}</td><td style="font-size:12px;">${lc?`${ld}/${lc}`:'â€”'}</td><td style="font-size:12px;">${rc?`${rd}/${rc}`:'â€”'}</td><td style="font-size:12px;">${rxc?`${rxd}/${rxc}`:'â€”'}</td><td><button onclick="openCons('${v.id}')">Open</button></td></tr>`;
  });
  document.getElementById('table-cons').innerHTML=h;
}

function renderAllPats(){
  const term=(document.getElementById('allpat-search')?.value||'').toLowerCase();
  const ageF=parseInt(document.getElementById('allpat-age')?.value)||0;
  let h=`<tr><th>Patient</th><th>Age</th><th>Visits</th><th>Last Visit</th><th>Diagnoses</th><th>Action</th></tr>`;
  let filtered=patients.filter(p=>p.name.toLowerCase().includes(term));
  if(ageF>0)filtered=filtered.filter(p=>p.ageVal===ageF);
  if(!filtered.length)h+=`<tr><td colspan="6" class="emp">No patients found</td></tr>`;
  filtered.forEach(p=>{
    const pv=visits.filter(v=>v.patId===p.id);
    const last=pv.length?pv[pv.length-1]:null;
    const dxs=[...new Set(pv.map(v=>v.clinical?.finalDx||v.clinical?.diffDx).filter(Boolean))].slice(0,3).join('; ');
    h+=`<tr><td><b>${p.name}</b></td><td>${p.ageVal} ${p.ageUnit}</td><td>${pv.length}</td><td>${last?last.date+' <span class="badge bgr" style="font-size:10px;">'+last.status.replace(/_/g,' ')+'</span>':'â€”'}</td><td style="font-size:12px;max-width:200px;">${dxs||'â€”'}</td><td><div style="display:flex;gap:3px;"><button class="bsm bo" onclick="openChart('${p.id}')">Chart</button>${last?`<button class="bsm bp" onclick="openCons('${last.id}')">Open</button>`:''}</div></td></tr>`;
  });
  document.getElementById('table-allpats').innerHTML=h;
}

function openCons(id){
  activeVid=id;
  const v=visits.find(x=>x.id===id);
  const p=patients.find(x=>x.id===v.patId);
  document.getElementById('c-name').innerText=v.name;
  document.getElementById('c-date').innerText=v.date;
  document.getElementById('c-pay').innerHTML=payBadge(v);
  const ctClass={GENERAL:'ct-gen',LAB_ONLY:'ct-lab',RADIOLOGY:'ct-rad',DENTAL:'ct-spc',ENT:'ct-spc',OTHER_SPECIAL:'ct-spc'}[v.consultType]||'ct-gen';
  document.getElementById('c-type-badge').innerHTML=`<span class="consult-type-badge ${ctClass}">${v.consultType||'GENERAL'}</span>`;
  document.getElementById('c-hist').innerHTML='<b style="font-size:10px;color:var(--mu);text-transform:uppercase;">Timeline</b><br>'+(v.timeline||[]).map(t=>`<span style="color:var(--mu);font-size:11px;">${t.time}</span> <b>${t.act}</b>${t.val?' â€” '+t.val:''} <span style="color:var(--s);font-size:11px;">(${t.by})</span>`).join('<br>');
  // Vitals
  if(v.vitals){
    const vt=v.vitals;
    document.getElementById('c-vitals').style.display='block';
    document.getElementById('c-vitals').innerHTML=`<b>Vitals (${vt.time}):</b> ${[vt.bp?'BP:'+vt.bp:'',vt.temp?'T:'+vt.temp+'Â°C':'',vt.weight?'Wt:'+vt.weight+'kg':'',vt.height?'Ht:'+vt.height+'cm':'',vt.pulse?'PR:'+vt.pulse:'',vt.spo2?'SpO2:'+vt.spo2+'%':'',vt.rr?'RR:'+vt.rr:''].filter(Boolean).join(' | ')} ${vt.weight&&vt.height?'| BMI:'+(vt.weight/((vt.height/100)*(vt.height/100))).toFixed(1):''}`;
  }else{document.getElementById('c-vitals').style.display='none';}
  // Obs/Gyn
  document.getElementById('ogBlock').style.display=(p&&p.gender==='Female')?'block':'none';
  // Restore clinical fields
  const cl=v.clinical||{};
  [{id:'hPC',k:'pc'},{id:'hHPC',k:'hpc'},{id:'hPMH',k:'pmh'},{id:'hOG',k:'obsGyn'},{id:'hFSH',k:'fsh'},{id:'hDrug',k:'drugHx'},{id:'cDiffDx',k:'diffDx'},{id:'cFinalDx',k:'finalDx'},{id:'cNotes',k:'notes'}].forEach(({id,k})=>{const el=document.getElementById(id);if(el)el.value=cl[k]||'';});
  document.getElementById('hLMP').value=cl.lmp||'';document.getElementById('hGP').value=cl.gravPara||'';document.getElementById('hAllergy').value=cl.allergies||'';
  // Lab results panel
  const labsWithRes=(v.labs||[]).filter(l=>l.done);
  const radWithRes=(v.radiology||[]).filter(r=>r.done);
  document.getElementById('lab-res-panel').style.display=labsWithRes.length?'block':'none';
  document.getElementById('rad-res-panel').style.display=radWithRes.length?'block':'none';
  if(labsWithRes.length)document.getElementById('lab-res-display').innerHTML=labsWithRes.map(l=>`<div class="lrc"><b>${l.name}</b><div style="margin-top:3px;white-space:pre-wrap;">${l.result}</div><div style="font-size:11px;color:var(--mu);margin-top:2px;">${l.resultTime} â€” ${l.resultBy}</div></div>`).join('');
  if(radWithRes.length)document.getElementById('rad-res-display').innerHTML=radWithRes.map(r=>`<div class="lrc" style="border-color:var(--pu);"><b>${r.name}</b><div style="margin-top:3px;white-space:pre-wrap;">${r.result}</div><div style="font-size:11px;color:var(--mu);margin-top:2px;">${r.resultTime} â€” ${r.resultBy}</div></div>`).join('');
  // Lab order section visibility
  document.getElementById('lab-order-sec').style.display=(v.consultType==='LAB_ONLY'||v.consultType==='RADIOLOGY')?'none':'block';
  // Build lab checkboxes
  selectedLabTests=new Set((v.labs||[]).filter(l=>l.name).map(l=>l.name));
  renderLabCheckList('');updateSelectedLabsDisplay(v);
  // Rad rows
  radRows=(v.radiology||[]).map((r,i)=>({id:i,radId:r.id,locked:r.done}));radRowId=radRows.length;
  renderRadRows();
  // Med rows
  medRows=(v.prescriptions||[]).map((r,i)=>({id:i,rxId:r.id,locked:r.dispensed}));medRowId=medRows.length;
  renderMedRows();
  // Clear search boxes
  document.getElementById('lab-search').value='';document.getElementById('med-search').value='';
  document.getElementById('drug-results').style.display='none';
  updateOrderSummary(v);
  // Actions
  const ab=document.getElementById('cons-actions');
  ab.innerHTML=`<button onclick="saveClinical()" style="background:#475569;color:#fff;font-weight:600;">ğŸ’¾ Save Notes</button><button onclick="openAdmit()" class="bpu">ğŸ› Admit</button><button onclick="printPatientReport()" class="bo bsm">ğŸ“„ Print Report PDF</button><button onclick="endVisit()" class="bd2" style="padding:6px 12px;font-size:13px;">âœ“ End Visit</button>`;
  document.getElementById('cons-form').style.display='block';
  document.getElementById('cons-form').scrollIntoView({behavior:'smooth'});
}

// Lab checkbox multi-select
function renderLabCheckList(filter){
  const list=document.getElementById('lab-check-list');
  const filtered=LAB_TESTS.filter(t=>t.name.toLowerCase().includes(filter.toLowerCase()));
  list.innerHTML=filtered.map(t=>`
    <div class="lab-check-item" onclick="toggleLabTest('${t.name}',${t.price})">
      <input type="checkbox" class="invt it" ${selectedLabTests.has(t.name)?'checked':''} id="lt-${t.name.replace(/\s/g,'_')}" onclick="event.stopPropagation();toggleLabTest('${t.name}',${t.price})">
      <span>${t.name}</span><span style="margin-left:auto;color:var(--mu);font-size:12px;">$${t.price.toFixed(2)}</span>
    </div>`).join('');
}
function filterLabTests(){renderLabCheckList(document.getElementById('lab-search').value);}
function toggleLabTest(name,price){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  if(selectedLabTests.has(name)){
    selectedLabTests.delete(name);
    v.labs=(v.labs||[]).filter(l=>l.name!==name);
    lg(v,'Lab Removed',name);
  }else{
    selectedLabTests.add(name);
    if(!(v.labs||[]).find(l=>l.name===name)){
      v.labs=v.labs||[];
      v.labs.push({id:'L-'+Date.now().toString().slice(-6),name,price,result:'',resultTime:'',resultBy:'',done:false});
      lg(v,'Lab Ordered',name);
    }
  }
  if(!v.consultFee&&v.labs.length)v.consultFee=CONSULT_FEE;
  renderLabCheckList(document.getElementById('lab-search').value);
  updateSelectedLabsDisplay(v);updateOrderSummary(v);save();
}
function updateSelectedLabsDisplay(v){
  const sel=document.getElementById('selected-labs-display');
  const labs=(v.labs||[]).filter(l=>l.name);
  sel.innerHTML=labs.length?`<div style="font-size:12px;color:var(--mu);margin-bottom:3px;">${labs.length} test(s) selected:</div>`+labs.map(l=>`<span class="tag tl" style="margin-bottom:3px;">${l.name}${l.done?' âœ“':''}</span>`).join(' '):'';
}

// Radiology rows
function addRadRow(){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const rid='R-'+Date.now().toString().slice(-6);
  v.radiology=v.radiology||[];
  v.radiology.push({id:rid,name:'',price:0,result:'',resultTime:'',resultBy:'',done:false});
  radRows.push({id:radRowId++,radId:rid,locked:false});
  renderRadRows();updateOrderSummary(v);
}
function removeRadRow(rowId){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const row=radRows.find(r=>r.id===rowId);if(!row)return;
  if(row.locked)return alert('Cannot remove a completed procedure.');
  v.radiology=(v.radiology||[]).filter(r=>r.id!==row.radId);
  radRows=radRows.filter(r=>r.id!==rowId);
  renderRadRows();save();updateOrderSummary(v);
}
function renderRadRows(){
  const c=document.getElementById('rad-orders-list');
  if(!radRows.length){c.innerHTML='<div class="emp">No radiology orders added.</div>';return;}
  c.innerHTML=radRows.map(r=>`<div class="or rr" id="rad-row-${r.id}">
    <div><label>Procedure</label>
      <select onchange="onRadSelect(${r.id},'${r.radId}')" ${r.locked?'disabled':''}>
        <option value="">-- Select --</option>
        ${RADIOLOGY_PROCS.map(p=>`<option value="${p.name}|${p.price}">${p.name} ($${p.price.toFixed(2)})</option>`).join('')}
      </select>${r.locked?'<span style="font-size:11px;color:var(--a);margin-left:4px;">âœ“ Done</span>':''}
    </div>
    <div style="display:flex;align-items:flex-end;padding-bottom:3px;">${!r.locked?`<button class="bd2" onclick="removeRadRow(${r.id})">âœ•</button>`:'<span></span>'}</div>
  </div>`).join('');
}
function onRadSelect(rowId,radId){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const row=document.getElementById(`rad-row-${rowId}`);
  const val=row?.querySelector('select')?.value;if(!val)return;
  const[name,price]=val.split('|');
  const rad=(v.radiology||[]).find(r=>r.id===radId);
  if(rad){rad.name=name;rad.price=parseFloat(price);}
  if(!v.consultFee)v.consultFee=CONSULT_FEE;
  lg(v,'Radiology Ordered',name);save();updateOrderSummary(v);
}

// Med search + formulation display
function filterMeds(){
  const q=document.getElementById('med-search').value.toLowerCase();
  if(!q){document.getElementById('drug-results').style.display='none';return;}
  const matches=inventory.filter(i=>i.category==='Medication'&&(i.name.toLowerCase().includes(q)||((i.drugClass||'').toLowerCase().includes(q))||((i.formulation||'').toLowerCase().includes(q)))).slice(0,10);
  const dr=document.getElementById('drug-results');
  if(!matches.length){dr.style.display='none';return;}
  dr.style.display='block';
  dr.innerHTML=matches.map(m=>`<div class="drug-item" onclick="selectDrug('${enc(m.name)}','${enc(m.strength||'')}','${enc(m.formulation||'')}',${m.price},'${enc(m.drugClass||'')}')">
    <b>${m.name}</b> ${m.strength||''} ${formBadge(m.formulation||'')}
    <span style="float:right;color:var(--mu);font-size:12px;">$${m.price.toFixed(2)} | Stock:${m.stock} ${m.unit}</span>
    <div style="font-size:11px;color:var(--mu);">${m.drugClass||''}</div>
  </div>`).join('');
}
function formBadge(f){
  const map={Tablet:'f-tab',Capsule:'f-cap',Syrup:'f-syr',Suspension:'f-syr','Injection (IV)':'f-inj','Injection (IM)':'f-inj','Injection (SC)':'f-inj','IV Fluid':'f-inj',Inhaler:'f-inh',Cream:'f-cre',Ointment:'f-cre',Drops:'f-oth',Powder:'f-oth'};
  const cls=map[f]||'f-oth';
  return`<span class="formulation-badge ${cls}">${f}</span>`;
}
function selectDrug(eName,eStr,eForm,price,eDrugClass){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const name=dec(eName);const strength=dec(eStr);const form=dec(eForm);const drugClass=dec(eDrugClass);
  const rid='Rx-'+Date.now().toString().slice(-6);
  v.prescriptions=v.prescriptions||[];
  v.prescriptions.push({id:rid,name,strength,formulation:form,drugClass,price,qty:1,instructions:'Once daily (OD)',dispensed:false,dispensedTime:'',dispensedBy:''});
  medRows.push({id:medRowId++,rxId:rid,locked:false});
  if(!v.consultFee)v.consultFee=CONSULT_FEE;
  lg(v,'Prescribed',`${name} ${strength} ${form}`);
  document.getElementById('med-search').value='';document.getElementById('drug-results').style.display='none';
  renderMedRows();save();updateOrderSummary(v);
}

function addMedRow(){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const rid='Rx-'+Date.now().toString().slice(-6);
  v.prescriptions=v.prescriptions||[];
  v.prescriptions.push({id:rid,name:'',strength:'',formulation:'',drugClass:'',price:0,qty:1,instructions:'Once daily (OD)',dispensed:false,dispensedTime:'',dispensedBy:''});
  medRows.push({id:medRowId++,rxId:rid,locked:false});
  renderMedRows();updateOrderSummary(v);
}
function removeMedRow(rowId){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const row=medRows.find(r=>r.id===rowId);if(!row)return;
  if(row.locked)return alert('Cannot remove a dispensed prescription.');
  v.prescriptions=(v.prescriptions||[]).filter(r=>r.id!==row.rxId);
  medRows=medRows.filter(r=>r.id!==rowId);
  renderMedRows();save();updateOrderSummary(v);
}
function renderMedRows(){
  const v=visits.find(x=>x.id===activeVid);
  const c=document.getElementById('med-orders-list');
  if(!medRows.length){c.innerHTML='<div class="emp">Use search above to add medications.</div>';return;}
  c.innerHTML=medRows.map(r=>{
    const rx=(v?.prescriptions||[]).find(p=>p.id===r.rxId)||{};
    return`<div class="cb2" id="med-row-${r.id}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
        <div style="flex:1;">
          <b style="font-size:13px;">${rx.name||'â€”'}</b> ${rx.strength?`<span style="color:var(--mu);font-size:12px;">${rx.strength}</span>`:''} ${rx.formulation?formBadge(rx.formulation):''}
          ${rx.drugClass?`<span style="font-size:11px;color:var(--mu);margin-left:4px;">${rx.drugClass}</span>`:''}
          ${r.locked?'<span style="color:var(--a);font-size:11px;margin-left:6px;">âœ… Dispensed</span>':''}
          <div style="display:flex;gap:6px;margin-top:5px;align-items:center;flex-wrap:wrap;">
            <select onchange="onMedInst(${r.id},'${r.rxId}')" ${r.locked?'disabled':''} style="width:auto;flex:1;min-width:160px;margin:0;font-size:12px;">
              ${DOSAGE_OPTS.map(d=>`<option ${rx.instructions===d?'selected':''}>${d}</option>`).join('')}
            </select>
            <input type="number" min="1" value="${rx.qty||1}" onchange="onMedQty(${r.id},'${r.rxId}')" ${r.locked?'disabled':''} style="width:60px;margin:0;font-size:12px;text-align:center;">
            <span style="font-size:12px;color:var(--mu);">= $${((rx.price||0)*(rx.qty||1)).toFixed(2)}</span>
          </div>
        </div>
        ${!r.locked?`<button class="bd2" style="margin-top:3px;" onclick="removeMedRow(${r.id})">âœ•</button>`:''}
      </div>
    </div>`;
  }).join('');
}
function onMedInst(rowId,rxId){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const row=document.getElementById(`med-row-${rowId}`);
  const rx=(v.prescriptions||[]).find(r=>r.id===rxId);
  if(rx&&row)rx.instructions=row.querySelector('select')?.value;
  save();updateOrderSummary(v);
}
function onMedQty(rowId,rxId){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const row=document.getElementById(`med-row-${rowId}`);
  const rx=(v.prescriptions||[]).find(r=>r.id===rxId);
  if(rx&&row)rx.qty=parseInt(row.querySelector('input[type=number]')?.value)||1;
  save();updateOrderSummary(v);renderMedRows();
}

function updateOrderSummary(v){
  if(!v)v=visits.find(x=>x.id===activeVid);if(!v)return;
  const body=document.getElementById('order-sum-body');if(!body)return;
  let total=v.consultFee||0,html='';
  if(v.consultFee)html+=`<div class="si"><span><span class="tag tc">CONSULT</span>Consultation Fee</span><span>$${v.consultFee.toFixed(2)}</span></div>`;
  (v.labs||[]).filter(l=>l.name).forEach(l=>{html+=`<div class="si"><span><span class="tag tl">LAB</span>${l.name}${l.done?' âœ“':''}</span><span>$${l.price.toFixed(2)}</span></div>`;total+=l.price;});
  (v.radiology||[]).filter(r=>r.name).forEach(r=>{html+=`<div class="si"><span><span class="tag tr2">RAD</span>${r.name}${r.done?' âœ“':''}</span><span>$${r.price.toFixed(2)}</span></div>`;total+=r.price;});
  (v.prescriptions||[]).filter(r=>r.name).forEach(r=>{const lt=r.price*r.qty;html+=`<div class="si"><span><span class="tag tm">RX</span>${r.name} ${r.strength||''} ${formBadge(r.formulation||'')} Ã— ${r.qty}</span><span>$${lt.toFixed(2)}</span></div>`;total+=lt;});
  if(v.discount)html+=`<div class="si" style="color:var(--a);"><span>Discount (${v.discountReason||''})</span><span>-$${v.discount.toFixed(2)}</span></div>`;
  html+=`<div class="si"><span>TOTAL</span><span>$${Math.max(0,total-(v.discount||0)).toFixed(2)}</span></div>`;
  body.innerHTML=html;
}

function saveClinical(){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  v.clinical=v.clinical||{};
  v.clinical.pc=document.getElementById('hPC').value;v.clinical.hpc=document.getElementById('hHPC').value;
  v.clinical.pmh=document.getElementById('hPMH').value;v.clinical.lmp=document.getElementById('hLMP').value;
  v.clinical.gravPara=document.getElementById('hGP').value;v.clinical.obsGyn=document.getElementById('hOG').value;
  v.clinical.fsh=document.getElementById('hFSH').value;v.clinical.drugHx=document.getElementById('hDrug').value;
  v.clinical.allergies=document.getElementById('hAllergy').value;v.clinical.diffDx=document.getElementById('cDiffDx').value;
  v.clinical.finalDx=document.getElementById('cFinalDx').value;v.clinical.notes=document.getElementById('cNotes').value;
  if(!v.cleared.includes('Doctor'))v.cleared.push('Doctor');
  lg(v,'Clinical notes saved');save();
}

function endVisit(){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  saveClinical();v.status='DISCHARGED';
  lg(v,'Discharged');save();document.getElementById('cons-form').style.display='none';renderCons();
  alert(`${v.name} discharged.`);
}
function openAdmit(){document.getElementById('admitWard').value='';document.getElementById('admitNotes').value='';oModal('admit-modal');}
function confAdmit(){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  saveClinical();v.status='ADMITTED';v.admitted=true;v.admissionWard=document.getElementById('admitWard').value;
  lg(v,'Admitted',`Ward: ${v.admissionWard}`);
  save();cModal('admit-modal');document.getElementById('cons-form').style.display='none';renderCons();
  alert(`${v.name} admitted.`);
}
function tClin(h){h.classList.toggle('open');h.nextElementSibling.classList.toggle('open');}

// Print patient report PDF
function printPatientReport(){
  const v=visits.find(x=>x.id===activeVid);if(!v)return;
  const p=patients.find(x=>x.id===v.patId);
  const cl=v.clinical||{};
  saveClinical();
  document.getElementById('pra-sub').innerText='Patient Clinical Report';
  document.getElementById('pra-con').innerHTML=`
    <div style="margin-bottom:14px;background:#f8fafc;border-radius:6px;padding:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:13px;">
        <div><b>Patient:</b> ${v.name}</div><div><b>Date:</b> ${v.date}</div>
        <div><b>Age:</b> ${p?p.ageVal+' '+p.ageUnit:'â€”'}</div><div><b>Gender:</b> ${p?p.gender:'â€”'}</div>
        <div><b>Phone:</b> ${p?p.phone||'â€”':'â€”'}</div><div><b>Address:</b> ${p?p.address||'â€”':'â€”'}</div>
        ${p?.kinName?`<div><b>Next of Kin:</b> ${p.kinName} ${p.kinPhone?'/ '+p.kinPhone:''}</div>`:''}
        <div><b>Consult Type:</b> ${v.consultType||'GENERAL'}</div>
        ${v.admitted?`<div><b>Admission Ward:</b> ${v.admissionWard}</div>`:''}
      </div>
    </div>
    ${v.vitals?`<div style="margin-bottom:12px;"><b>VITALS:</b> ${[v.vitals.bp?'BP:'+v.vitals.bp:'',v.vitals.temp?'Temp:'+v.vitals.temp+'Â°C':'',v.vitals.weight?'Wt:'+v.vitals.weight+'kg':'',v.vitals.height?'Ht:'+v.vitals.height+'cm':'',v.vitals.pulse?'Pulse:'+v.vitals.pulse:'',v.vitals.spo2?'SpO2:'+v.vitals.spo2+'%':'',v.vitals.rr?'RR:'+v.vitals.rr:''].filter(Boolean).join(' | ')}${v.vitals.weight&&v.vitals.height?' | BMI:'+(v.vitals.weight/((v.vitals.height/100)*(v.vitals.height/100))).toFixed(1):''}</div>`:''}
    ${cl.pc?`<div style="margin-bottom:8px;"><b>PRESENTING COMPLAINT:</b><div style="margin-top:3px;padding-left:10px;">${cl.pc}</div></div>`:''}
    ${cl.hpc?`<div style="margin-bottom:8px;"><b>HISTORY OF PRESENTING COMPLAINT:</b><div style="margin-top:3px;padding-left:10px;">${cl.hpc}</div></div>`:''}
    ${cl.pmh?`<div style="margin-bottom:8px;"><b>PAST MEDICAL/SURGICAL HISTORY:</b><div style="margin-top:3px;padding-left:10px;">${cl.pmh}</div></div>`:''}
    ${cl.obsGyn?`<div style="margin-bottom:8px;"><b>OBS/GYN HISTORY:</b><div style="margin-top:3px;padding-left:10px;">${cl.lmp?'LMP: '+cl.lmp+' | ':''} ${cl.gravPara?'G/P: '+cl.gravPara+'<br>':''} ${cl.obsGyn}</div></div>`:''}
    ${cl.fsh?`<div style="margin-bottom:8px;"><b>FAMILY & SOCIAL HISTORY:</b><div style="margin-top:3px;padding-left:10px;">${cl.fsh}</div></div>`:''}
    ${cl.drugHx||cl.allergies?`<div style="margin-bottom:8px;"><b>DRUG HISTORY:</b><div style="margin-top:3px;padding-left:10px;">${cl.drugHx||'â€”'}</div><b>ALLERGIES:</b> ${cl.allergies||'None known'}</div>`:''}
    ${cl.diffDx?`<div style="margin-bottom:8px;"><b>DIFFERENTIAL DIAGNOSIS:</b><div style="margin-top:3px;padding-left:10px;">${cl.diffDx}</div></div>`:''}
    ${(v.labs||[]).filter(l=>l.name).length?`<div style="margin-bottom:8px;"><b>LAB INVESTIGATIONS:</b><table class="pit"><tr><th>Test</th><th>Result</th><th>Status</th></tr>${(v.labs||[]).filter(l=>l.name).map(l=>`<tr><td>${l.name}</td><td>${l.result||'Pending'}</td><td>${l.done?'Done':'Pending'}</td></tr>`).join('')}</table></div>`:''}
    ${(v.radiology||[]).filter(r=>r.name).length?`<div style="margin-bottom:8px;"><b>RADIOLOGY/PROCEDURES:</b><table class="pit"><tr><th>Procedure</th><th>Result</th><th>Status</th></tr>${(v.radiology||[]).filter(r=>r.name).map(r=>`<tr><td>${r.name}</td><td>${r.result||'Pending'}</td><td>${r.done?'Done':'Pending'}</td></tr>`).join('')}</table></div>`:''}
    ${cl.finalDx?`<div style="margin-bottom:8px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:5px;padding:9px;"><b>FINAL DIAGNOSIS:</b> <span style="font-size:15px;">${cl.finalDx}</span></div>`:''}
    ${cl.notes?`<div style="margin-bottom:8px;"><b>CLINICAL NOTES / MANAGEMENT PLAN:</b><div style="margin-top:3px;padding-left:10px;">${cl.notes}</div></div>`:''}
    ${(v.prescriptions||[]).filter(r=>r.name).length?`<div style="margin-bottom:8px;"><b>PRESCRIPTION:</b><table class="pit"><tr><th>Drug</th><th>Strength</th><th>Formulation</th><th>Qty</th><th>Instructions</th><th>Class</th></tr>${(v.prescriptions||[]).filter(r=>r.name).map(r=>`<tr><td>${r.name}</td><td>${r.strength||'â€”'}</td><td>${r.formulation||'â€”'}</td><td>${r.qty}</td><td>${r.instructions}</td><td>${r.drugClass||'â€”'}</td></tr>`).join('')}</table></div>`:''}
    ${(v.treatmentChart||[]).length?`<div style="margin-bottom:8px;"><b>TREATMENT CHART:</b><table class="pit"><tr><th>Drug</th><th>Dose</th><th>Route</th><th>Time</th><th>Nurse</th><th>Notes</th></tr>${v.treatmentChart.map(e=>`<tr><td>${e.drug}</td><td>${e.dose}</td><td>${e.route}</td><td>${e.time}</td><td>${e.by}</td><td>${e.notes||'â€”'}</td></tr>`).join('')}</table></div>`:''}
    <div style="margin-top:16px;font-size:11px;color:#666;border-top:1px solid #ccc;padding-top:8px;">
      Attending: ${currentUser.name} | Printed: ${new Date().toLocaleString()} | TALI MEDICALS HIMS v3.1<br>
      <i>This document is confidential and intended for medical records only.</i>
    </div>`;
  window.print();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BILLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fBill(f,btn){billFilter=f;document.querySelectorAll('#sec-billing .st').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderBilling();}
function renderBilling(){
  let q=visits.filter(v=>totalBill(v)>0||v.payments?.length>0);
  if(billFilter!=='all')q=q.filter(v=>billStatus(v)===billFilter);
  let h=`<tr><th>Patient</th><th>Date</th><th>Type</th><th>Bill Items</th><th>Total</th><th>Paid</th><th>Balance</th><th>Status</th><th>Actions</th></tr>`;
  if(!q.length)h+=`<tr><td colspan="9" class="emp">No records</td></tr>`;
  q.forEach(v=>{
    const tot=totalBill(v),bal=tot-v.totalPaid;const bs=billStatus(v);
    const bcls=bs==='PAID'?'bpd':bs==='PARTIAL'?'bpa':'bp2';
    h+=`<tr><td><b>${v.name}</b><br><span style="font-size:10px;color:var(--mu);">${v.status.replace(/_/g,' ')}</span></td><td>${v.date}</td>
      <td><span class="consult-type-badge ct-${(v.consultType||'GEN').toLowerCase().split('_')[0]}">${v.consultType||'GEN'}</span></td>
      <td><details><summary style="font-size:12px;">${(v.labs||[]).filter(l=>l.name).length+(v.radiology||[]).filter(r=>r.name).length+(v.prescriptions||[]).filter(r=>r.name).length+(v.consultFee?1:0)} item(s)</summary>
        <div style="margin-top:5px;">
          ${v.consultFee?'<span class="tag tc">CONSULT</span> ':''} 
          ${(v.labs||[]).filter(l=>l.name).map(l=>`<span class="tag tl">${l.name}</span>`).join(' ')}
          ${(v.radiology||[]).filter(r=>r.name).map(r=>`<span class="tag tr2">${r.name}</span>`).join(' ')}
          ${(v.prescriptions||[]).filter(r=>r.name).map(r=>`<span class="tag tm">${r.name}</span>`).join(' ')}
        </div></details></td>
      <td><b>$${tot.toFixed(2)}</b></td>
      <td style="color:var(--a);">$${v.totalPaid.toFixed(2)}</td>
      <td style="color:${bal>0.001?'var(--d)':'var(--a)'};font-weight:${bal>0.001?700:400};">$${bal.toFixed(2)}</td>
      <td><span class="badge ${bcls}">${bs}</span></td>
      <td><div style="display:flex;gap:3px;">
        <button class="ba bsm" onclick="openPayModal('${v.id}')">Pay</button>
        <button class="bsm bo" onclick="printInvoice('${v.id}')">ğŸ–¨</button>
      </div></td></tr>`;
  });
  document.getElementById('table-bill').innerHTML=h;
}

function openPayModal(id){
  activePayVid=id;
  const v=visits.find(x=>x.id===id);const tot=totalBillGross(v);
  document.getElementById('pay-title').innerText=`Payment â€” ${v.name}`;
  let bd=`<table class="pit"><tr><th>Item</th><th>Type</th><th>Qty</th><th>Amount</th></tr>`;
  if(v.consultFee)bd+=`<tr><td>Consultation Fee</td><td>CONSULT</td><td>1</td><td>$${v.consultFee.toFixed(2)}</td></tr>`;
  (v.labs||[]).filter(l=>l.name).forEach(l=>bd+=`<tr><td>${l.name}</td><td>LAB</td><td>1</td><td>$${l.price.toFixed(2)}</td></tr>`);
  (v.radiology||[]).filter(r=>r.name).forEach(r=>bd+=`<tr><td>${r.name}</td><td>RAD</td><td>1</td><td>$${r.price.toFixed(2)}</td></tr>`);
  (v.prescriptions||[]).filter(r=>r.name).forEach(r=>bd+=`<tr><td>${r.name} ${r.strength||''}</td><td>RX</td><td>${r.qty}</td><td>$${(r.price*r.qty).toFixed(2)}</td></tr>`);
  bd+=`<tr style="font-weight:700;"><td colspan="3">Gross Total</td><td>$${tot.toFixed(2)}</td></tr></table>`;
  document.getElementById('pay-breakdown').innerHTML=bd;
  document.getElementById('discAmt').value=v.discount||'';
  document.getElementById('discReason').value=v.discountReason||'';
  document.getElementById('payAmt').value=(totalBill(v)-v.totalPaid).toFixed(2);
  updPayBal();oModal('pay-modal');
}
function updPayBal(){
  const v=visits.find(x=>x.id===activePayVid);if(!v)return;
  const disc=parseFloat(document.getElementById('discAmt').value)||0;
  const gross=totalBillGross(v);const tot=Math.max(0,gross-disc);const bal=Math.max(0,tot-v.totalPaid);
  const paying=parseFloat(document.getElementById('payAmt').value)||0;
  document.getElementById('pay-bal').innerHTML=`Gross: <b>$${gross.toFixed(2)}</b> &nbsp;|&nbsp; Discount: <b style="color:var(--a);">-$${disc.toFixed(2)}</b> &nbsp;|&nbsp; Net: <b>$${tot.toFixed(2)}</b><br>Paid: <b style="color:var(--a);">$${v.totalPaid.toFixed(2)}</b> &nbsp;|&nbsp; Balance: <b style="color:var(--d);">$${bal.toFixed(2)}</b> &nbsp;|&nbsp; Paying Now: <b>$${paying.toFixed(2)}</b>`;
}
function recPayment(){
  const v=visits.find(x=>x.id===activePayVid);
  const disc=parseFloat(document.getElementById('discAmt').value)||0;
  const discR=document.getElementById('discReason').value;
  const amount=parseFloat(document.getElementById('payAmt').value)||0;
  const method=document.getElementById('payMethod').value;
  const gross=totalBillGross(v);const tot=Math.max(0,gross-disc);const bal=tot-v.totalPaid;
  if(amount<=0)return alert('Enter valid amount.');
  if(amount>bal+0.001)return alert(`Exceeds balance $${bal.toFixed(2)}.`);
  v.discount=disc;v.discountReason=discR;
  v.totalPaid+=amount;
  v.payments.push({amount,method,time:new Date().toLocaleTimeString(),by:currentUser.name});
  lg(v,'Payment',`$${amount.toFixed(2)} via ${method}`);
  if(disc>0)lg(v,'Discount',`$${disc.toFixed(2)} â€” ${discR}`);
  if(v.totalPaid>=tot-0.001){v.totalPaid=tot;if(!v.cleared.includes('Billing'))v.cleared.push('Billing');alert('Bill cleared.');}
  else alert(`Partial payment. Remaining: $${(tot-v.totalPaid).toFixed(2)}`);
  save();cModal('pay-modal');renderBilling();
}
function exportCSV(){
  const today=new Date().toLocaleDateString();
  const tv=visits.filter(v=>v.date===today);if(!tv.length)return alert('No visits today.');
  const rows=[['ID','Patient','Date','Status','Total','Paid','Balance','Bill Status','Methods']];
  tv.forEach(v=>{const t=totalBill(v);rows.push([v.id,v.name,v.date,v.status,t.toFixed(2),v.totalPaid.toFixed(2),(t-v.totalPaid).toFixed(2),billStatus(v),(v.payments||[]).map(p=>p.method).join(';')]);});
  const blob=new Blob([rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`tali_${today.replace(/\//g,'-')}.csv`;a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function swLab(tab,btn){labTab=tab;document.querySelectorAll('#sec-lab .st').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderLab();}
function renderLab(){
  document.getElementById('lab-summary-panel').style.display=labTab==='summary'?'block':'none';
  document.getElementById('lab-entry').style.display='none';
  if(labTab==='summary'){buildLabSummary();return;}
  let q;
  if(labTab==='pending')q=visits.filter(v=>(v.labs||[]).some(l=>l.name&&!l.done));
  else if(labTab==='completed')q=visits.filter(v=>(v.labs||[]).some(l=>l.done));
  else q=visits.filter(v=>(v.labs||[]).some(l=>l.name));
  let h=`<tr><th>Patient</th><th>Date</th><th>Type</th><th>Pay Status</th><th>Tests</th><th>Status</th><th>Actions</th></tr>`;
  if(!q.length)h+=`<tr><td colspan="7" class="emp">No records</td></tr>`;
  q.forEach(v=>{
    const labs=v.labs||[];const pending=labs.filter(l=>l.name&&!l.done);const done=labs.filter(l=>l.done);
    const testsHtml=labs.filter(l=>l.name).map(l=>`<span class="badge ${l.done?'bpd':'bwn'}" style="font-size:10px;margin:1px;">${l.name}${l.done?' âœ“':''}</span>`).join(' ');
    const ctClass={GENERAL:'ct-gen',LAB_ONLY:'ct-lab',RADIOLOGY:'ct-rad',DENTAL:'ct-spc',ENT:'ct-spc',OTHER_SPECIAL:'ct-spc'}[v.consultType]||'ct-gen';
    h+=`<tr><td><b>${v.name}</b></td><td>${v.date}</td><td><span class="consult-type-badge ${ctClass}">${v.consultType||'GEN'}</span></td><td>${payBadge(v)}</td><td style="font-size:12px;">${testsHtml}</td>
      <td>${pending.length?`<span class="badge bwn">${pending.length} Pending</span>`:`<span class="badge bpd">All Done</span>`}</td>
      <td><div style="display:flex;gap:3px;flex-wrap:wrap;">
        ${pending.length?`<button class="bsm bp" onclick="openLab('${v.id}')">Enter Results</button>`:''}
        ${done.length?`<button class="bsm bo" onclick="printAllLabs('${v.id}')">ğŸ–¨ Print</button>`:''}
        <button class="bsm" style="background:var(--s);color:#fff;" onclick="openChart('${v.id}')">Chart</button>
      </div></td></tr>`;
  });
  document.getElementById('table-lab').innerHTML=h;
}

function buildLabSummary(){
  const now=new Date();const m=now.getMonth();const y=now.getFullYear();
  const allLabs=visits.flatMap(v=>(v.labs||[]).filter(l=>l.name));
  const mLabs=visits.filter(v=>{const d=new Date(v.date);return d.getMonth()===m&&d.getFullYear()===y;}).flatMap(v=>(v.labs||[]).filter(l=>l.name));
  const counts={};mLabs.forEach(l=>{counts[l.name]=(counts[l.name]||0)+1;});
  const totalOrdered=allLabs.length,totalDone=allLabs.filter(l=>l.done).length;
  const mOrdered=mLabs.length,mDone=mLabs.filter(l=>l.done).length;
  let h=`<tr><th>Test</th><th>This Month</th><th>Completed</th><th>Total Ever</th></tr>`;
  LAB_TESTS.forEach(t=>{
    const mo=mLabs.filter(l=>l.name===t.name).length;
    const mc=mLabs.filter(l=>l.name===t.name&&l.done).length;
    const tot=allLabs.filter(l=>l.name===t.name).length;
    if(tot>0)h+=`<tr><td>${t.name}</td><td>${mo}</td><td>${mc}</td><td>${tot}</td></tr>`;
  });
  h+=`<tr style="font-weight:700;"><td>TOTAL</td><td>${mOrdered}</td><td>${mDone}</td><td>${totalOrdered}</td></tr>`;
  document.getElementById('lab-stats-table').innerHTML=h;
  // Chart
  dChart('labch');
  const ctx=document.getElementById('ch-lab-stats');if(!ctx)return;
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  if(!sorted.length)return;
  charts.labch=new Chart(ctx,{type:'bar',data:{labels:sorted.map(x=>x[0]),datasets:[{label:'Requests this month',data:sorted.map(x=>x[1]),backgroundColor:'rgba(124,58,237,.7)'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{stepSize:1}}}}});
}

function openLab(id){
  activeVid=id;
  const v=visits.find(x=>x.id===id);
  const pending=(v.labs||[]).filter(l=>l.name&&!l.done);
  document.getElementById('lab-hdr').innerText=`Results â€” ${v.name}`;
  document.getElementById('lab-tests-entry').innerHTML=pending.map((l,i)=>`<div style="margin-bottom:10px;"><label>${l.name} ${payBadge(v)}</label><textarea id="lab-result-${i}" data-lid="${l.id}" rows="3" placeholder="Enter results for ${l.name}..."></textarea></div>`).join('');
  document.getElementById('lab-entry').style.display='block';
  document.getElementById('lab-entry').scrollIntoView({behavior:'smooth'});
}
function updateLab(){
  const v=visits.find(x=>x.id===activeVid);
  const pending=(v.labs||[]).filter(l=>l.name&&!l.done);
  let count=0;
  pending.forEach((l,i)=>{const res=document.getElementById(`lab-result-${i}`)?.value.trim();if(res){l.result=res;l.done=true;l.resultTime=new Date().toLocaleTimeString();l.resultBy=currentUser.name;count++;}});
  if(!count)return alert('Enter at least one result.');
  v.status='LAB_READY';if(!v.cleared.includes('Lab'))v.cleared.push('Lab');
  lg(v,'Lab Results Released');save();document.getElementById('lab-entry').style.display='none';renderLab();
  alert('Results released to doctor queue.');
}
function printAllLabs(id){
  const v=visits.find(x=>x.id===id);const p=patients.find(x=>x.id===v.patId);
  const done=(v.labs||[]).filter(l=>l.done);
  document.getElementById('pra-sub').innerText='Laboratory Results Report';
  document.getElementById('pra-con').innerHTML=`<p style="font-size:12px;margin-bottom:10px;"><b>Patient:</b> ${v.name} &nbsp; <b>Age:</b> ${p?p.ageVal+' '+p.ageUnit:'â€”'} &nbsp; <b>Gender:</b> ${p?p.gender:'â€”'} &nbsp; <b>Date:</b> ${v.date}</p>${done.map(l=>`<div style="margin-bottom:14px;border:1px solid #ccc;border-radius:6px;padding:11px;"><h4 style="margin:0 0 7px 0;border-bottom:1px solid #eee;padding-bottom:5px;">${l.name}</h4><div style="white-space:pre-wrap;font-size:13px;line-height:1.6;">${l.result}</div><div style="font-size:11px;color:#666;margin-top:6px;">Reported: ${l.resultTime} by ${l.resultBy}</div></div>`).join('')}<div style="margin-top:14px;font-size:11px;color:#555;border-top:1px solid #ccc;padding-top:7px;">Printed: ${new Date().toLocaleString()} | TALI MEDICALS v3.1</div>`;
  window.print();
}
function printLabResults(){printAllLabs(activeVid);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHARMACY (PARTIAL DISPENSING)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function swPharm(tab,btn){pharmTab=tab;document.querySelectorAll('#sec-pharmacy .st').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderPharm();}
function renderPharm(){
  let q;
  if(pharmTab==='pending')q=visits.filter(v=>(v.prescriptions||[]).some(r=>r.name&&!r.dispensed));
  else q=visits.filter(v=>(v.prescriptions||[]).some(r=>r.dispensed));
  let h=`<tr><th>Patient</th><th>Date</th><th>Pay Status</th><th>Medications</th><th>Actions</th></tr>`;
  if(!q.length)h+=`<tr><td colspan="5" class="emp">No records</td></tr>`;
  q.forEach(v=>{
    const rxs=(v.prescriptions||[]).filter(r=>r.name);
    const medHtml=rxs.map(r=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px dashed var(--bd);">
      <div><span style="margin-right:6px;">${r.dispensed?'âœ…':'â³'}</span><b>${r.name}</b> ${r.strength||''} ${formBadge(r.formulation||'')} Ã— ${r.qty} <span style="color:var(--mu);font-size:11px;">(${r.instructions})</span>${r.dispensed?`<span style="font-size:11px;color:var(--a);margin-left:6px;">${r.dispensedTime} â€” ${r.dispensedBy}</span>`:''}</div>
      ${!r.dispensed?`<button class="bsm ba" onclick="dispenseOne('${v.id}','${r.id}')">Dispense</button>`:''}
    </div>`).join('');
    h+=`<tr><td><b>${v.name}</b></td><td>${v.date}</td><td>${payBadge(v)}</td><td style="min-width:300px;">${medHtml}</td>
      <td><div style="display:flex;gap:3px;flex-wrap:wrap;">
        ${rxs.some(r=>!r.dispensed)?`<button onclick="dispenseAll('${v.id}')" class="bsm ba">Dispense All</button>`:''}
        <button class="bsm" style="background:var(--s);color:#fff;" onclick="openChart('${v.id}')">Chart</button>
      </div></td></tr>`;
  });
  document.getElementById('table-pharm').innerHTML=h;
}

function dispenseOne(vid,rxId){
  const v=visits.find(x=>x.id===vid);
  const rx=(v.prescriptions||[]).find(r=>r.id===rxId);if(!rx)return;
  const item=inventory.find(i=>i.name===rx.name);
  if(!item||item.stock<rx.qty)return alert(`Insufficient stock: ${rx.name}. Stock: ${item?item.stock:0}, Need: ${rx.qty}`);
  item.stock-=rx.qty;
  item.history=item.history||[];item.history.push({type:'OUT',qty:rx.qty,reason:`Dispensed to ${v.name}`,date:v.date,by:currentUser.name});
  rx.dispensed=true;rx.dispensedTime=new Date().toLocaleTimeString();rx.dispensedBy=currentUser.name;
  lg(v,'Dispensed',`${rx.name} Ã— ${rx.qty}`);
  checkFullyDispensed(v);save();renderPharm();
}

function dispenseAll(vid){
  const v=visits.find(x=>x.id===vid);
  const pending=(v.prescriptions||[]).filter(r=>r.name&&!r.dispensed);
  for(let r of pending){
    const item=inventory.find(i=>i.name===r.name);
    if(!item||item.stock<r.qty)return alert(`Insufficient stock: ${r.name}. Stock:${item?item.stock:0}, Need:${r.qty}`);
  }
  pending.forEach(r=>{
    const item=inventory.find(i=>i.name===r.name);
    item.stock-=r.qty;item.history=item.history||[];item.history.push({type:'OUT',qty:r.qty,reason:`Dispensed to ${v.name}`,date:v.date,by:currentUser.name});
    r.dispensed=true;r.dispensedTime=new Date().toLocaleTimeString();r.dispensedBy=currentUser.name;
    lg(v,'Dispensed',`${r.name} Ã— ${r.qty}`);
  });
  checkFullyDispensed(v);save();renderPharm();alert(`All dispensed.`);
}
function checkFullyDispensed(v){
  if((v.prescriptions||[]).every(r=>r.dispensed)){
    if(!v.cleared.includes('Pharmacy'))v.cleared.push('Pharmacy');
    if(v.status!=='ADMITTED')v.status='DISCHARGED';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RADIOLOGY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function swRad(tab,btn){radTab=tab;document.querySelectorAll('#sec-radiology .st').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderRad();}
function renderRad(){
  let q;
  if(radTab==='pending')q=visits.filter(v=>(v.radiology||[]).some(r=>r.name&&!r.done));
  else if(radTab==='completed')q=visits.filter(v=>(v.radiology||[]).some(r=>r.done));
  else q=visits.filter(v=>(v.radiology||[]).some(r=>r.name));
  let h=`<tr><th>Patient</th><th>Date</th><th>Pay</th><th>Procedures</th><th>Status</th><th>Actions</th></tr>`;
  if(!q.length)h+=`<tr><td colspan="6" class="emp">No radiology requests</td></tr>`;
  q.forEach(v=>{
    const rads=v.radiology||[];const pending=rads.filter(r=>r.name&&!r.done);const done=rads.filter(r=>r.done);
    const radHtml=rads.filter(r=>r.name).map(r=>`<span class="badge ${r.done?'bpd':'bwn'}" style="font-size:10px;margin:1px;">${r.name}${r.done?' âœ“':''}</span>`).join(' ');
    h+=`<tr><td><b>${v.name}</b></td><td>${v.date}</td><td>${payBadge(v)}</td><td style="font-size:12px;">${radHtml}</td>
      <td>${pending.length?`<span class="badge bwn">${pending.length} Pending</span>`:`<span class="badge bpd">All Done</span>`}</td>
      <td><div style="display:flex;gap:3px;flex-wrap:wrap;">
        ${pending.length?`<button class="bsm bp" onclick="openRadEntry('${v.id}')">Enter Results</button>`:''}
        ${done.length?`<button class="bsm bo" onclick="printRadResults('${v.id}')">ğŸ–¨ Print</button>`:''}
        <button class="bsm" style="background:var(--s);color:#fff;" onclick="openChart('${v.id}')">Chart</button>
      </div></td></tr>`;
  });
  document.getElementById('table-rad').innerHTML=h;
}

function openRadEntry(id){
  activeVid=id;const v=visits.find(x=>x.id===id);
  const pending=(v.radiology||[]).filter(r=>r.name&&!r.done);
  document.getElementById('rad-hdr').innerText=`Radiology Results â€” ${v.name}`;
  document.getElementById('rad-tests-entry').innerHTML=pending.map((r,i)=>`<div style="margin-bottom:10px;"><label>${r.name} ${payBadge(v)}</label><textarea id="rad-result-${i}" data-rid="${r.id}" rows="3" placeholder="Enter report for ${r.name}..."></textarea></div>`).join('');
  document.getElementById('rad-entry').style.display='block';
  document.getElementById('rad-entry').scrollIntoView({behavior:'smooth'});
}
function updateRad(){
  const v=visits.find(x=>x.id===activeVid);
  const pending=(v.radiology||[]).filter(r=>r.name&&!r.done);
  let count=0;
  pending.forEach((r,i)=>{const res=document.getElementById(`rad-result-${i}`)?.value.trim();if(res){r.result=res;r.done=true;r.resultTime=new Date().toLocaleTimeString();r.resultBy=currentUser.name;count++;}});
  if(!count)return alert('Enter at least one result.');
  v.status='RAD_READY';if(!v.cleared.includes('Radiology'))v.cleared.push('Radiology');
  lg(v,'Radiology Results Released');save();document.getElementById('rad-entry').style.display='none';renderRad();
  alert('Results released to doctor queue.');
}
function printRadResults(id){
  const v=visits.find(x=>x.id===id);const p=patients.find(x=>x.id===v.patId);
  const done=(v.radiology||[]).filter(r=>r.done);
  document.getElementById('pra-sub').innerText='Radiology / Imaging Report';
  document.getElementById('pra-con').innerHTML=`<p style="font-size:12px;margin-bottom:10px;"><b>Patient:</b>${v.name} &nbsp;<b>Age:</b>${p?p.ageVal+' '+p.ageUnit:'â€”'} &nbsp;<b>Gender:</b>${p?p.gender:'â€”'} &nbsp;<b>Date:</b>${v.date}</p>${done.map(r=>`<div style="margin-bottom:14px;border:1px solid #ccc;border-radius:6px;padding:11px;"><h4 style="margin:0 0 7px 0;">${r.name}</h4><div style="white-space:pre-wrap;font-size:13px;">${r.result}</div><div style="font-size:11px;color:#666;margin-top:6px;">${r.resultTime} â€” ${r.resultBy}</div></div>`).join('')}<div style="font-size:11px;color:#555;border-top:1px solid #ccc;padding-top:7px;margin-top:12px;">TALI MEDICALS v3.1 | ${new Date().toLocaleString()}</div>`;
  window.print();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInventory(){
  // Build filter options
  const classes=[...new Set(inventory.map(i=>i.drugClass).filter(Boolean))].sort();
  const cats=[...new Set(inventory.map(i=>i.category).filter(Boolean))].sort();
  const cf=document.getElementById('inv-class-filter');const catf=document.getElementById('inv-cat-filter');
  if(cf)cf.innerHTML='<option value="">All Classes</option>'+classes.map(c=>`<option>${c}</option>`).join('');
  if(catf)catf.innerHTML='<option value="">All Categories</option>'+cats.map(c=>`<option>${c}</option>`).join('');
  const classF=(document.getElementById('inv-class-filter')?.value)||'';
  const catF=(document.getElementById('inv-cat-filter')?.value)||'';
  let inv=inventory;
  if(classF)inv=inv.filter(i=>i.drugClass===classF);
  if(catF)inv=inv.filter(i=>i.category===catF);
  let h=`<tr><th>Name</th><th>Strength</th><th>Formulation</th><th>Class</th><th>Stock</th><th>Unit</th><th>Price</th><th>Stock Value</th><th>Status</th><th>Actions</th></tr>`;
  if(!inv.length)h+=`<tr><td colspan="10" class="emp">No items</td></tr>`;
  inv.forEach(i=>{
    const low=i.stock<=i.reorderLevel;const ok=i.stock>i.reorderLevel*2;
    const st=low?`<span style="color:var(--d);font-weight:700;">âš  LOW</span>`:ok?`<span style="color:var(--a);">âœ“ OK</span>`:`<span style="color:var(--w);">âš  MOD</span>`;
    const val=(i.stock*i.price).toFixed(2);
    h+=`<tr><td><b>${i.name}</b></td><td>${i.strength||'â€”'}</td><td>${formBadge(i.formulation||'N/A')}</td><td style="font-size:12px;">${i.drugClass||'â€”'}</td><td><b>${i.stock}</b></td><td>${i.unit}</td><td>$${i.price.toFixed(2)}</td><td>$${val}</td><td>${st}</td>
      <td><div style="display:flex;gap:3px;">
        <button class="bsm bo" onclick="editInv('${i.id}')">Edit</button>
        <button class="bsm ba" onclick="restockInv('${i.id}')">+ Stock</button>
      </div></td></tr>`;
  });
  document.getElementById('table-inv').innerHTML=h;
}

function editInv(id){
  const i=inventory.find(x=>x.id===id);if(!i)return;
  document.getElementById('inv-modal-title').innerText='Edit Item';
  document.getElementById('invEditId').value=id;
  document.getElementById('invName').value=i.name;document.getElementById('invCat').value=i.category;
  document.getElementById('invClass').value=i.drugClass||'Other';document.getElementById('invForm').value=i.formulation||'Tablet';
  document.getElementById('invStrength').value=i.strength||'';document.getElementById('invPrice').value=i.price;
  document.getElementById('invReorder').value=i.reorderLevel;document.getElementById('invQty').value='';
  document.getElementById('invUnit').value=i.unit;
  document.getElementById('invBatch').value='';document.getElementById('invExpiry').value='';document.getElementById('invSupplier').value='';
  oModal('inv-add-modal');
}
function restockInv(id){
  const i=inventory.find(x=>x.id===id);if(!i)return;
  editInv(id);document.getElementById('inv-modal-title').innerText=`Restock â€” ${i.name}`;
}
function saveInvItem(){
  const name=document.getElementById('invName').value.trim();if(!name)return alert('Enter item name.');
  const price=parseFloat(document.getElementById('invPrice').value)||0;
  const qty=parseInt(document.getElementById('invQty').value)||0;
  const reorder=parseInt(document.getElementById('invReorder').value)||10;
  const editId=document.getElementById('invEditId').value;
  const histEntry=qty>0?{type:'IN',qty,batch:document.getElementById('invBatch').value,expiry:document.getElementById('invExpiry').value,supplier:document.getElementById('invSupplier').value,date:new Date().toLocaleDateString(),by:currentUser.name}:null;
  if(editId){
    const i=inventory.find(x=>x.id===editId);if(!i)return;
    i.name=name;i.category=document.getElementById('invCat').value;i.drugClass=document.getElementById('invClass').value;
    i.formulation=document.getElementById('invForm').value;i.strength=document.getElementById('invStrength').value;
    i.price=price;i.unit=document.getElementById('invUnit').value;i.reorderLevel=reorder;
    if(qty>0){i.stock+=qty;i.history=i.history||[];i.history.push(histEntry);}
  }else{
    inventory.push({id:'I-'+Date.now().toString().slice(-6),name,category:document.getElementById('invCat').value,drugClass:document.getElementById('invClass').value,formulation:document.getElementById('invForm').value,strength:document.getElementById('invStrength').value,stock:qty,unit:document.getElementById('invUnit').value,price,reorderLevel:reorder,history:histEntry?[histEntry]:[]});
  }
  save();cModal('inv-add-modal');renderInventory();document.getElementById('invEditId').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPENSES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fExp(f,btn){expFilter=f;document.querySelectorAll('#sec-expenses .st').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderExpenses();}
function renderExpenses(){
  const today=new Date().toLocaleDateString();
  const now=new Date();
  const weekAgo=new Date(now-7*86400000).toLocaleDateString();
  const monthStart=new Date(now.getFullYear(),now.getMonth(),1).toLocaleDateString();
  let exp=expenses;
  if(expFilter==='today')exp=exp.filter(e=>e.date===today);
  else if(expFilter==='week')exp=exp.filter(e=>new Date(e.date)>=new Date(weekAgo));
  else if(expFilter==='month')exp=exp.filter(e=>new Date(e.date)>=new Date(monthStart));
  const total=exp.reduce((s,e)=>s+e.amount,0);
  let h=`<tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Reference</th><th>By</th></tr>`;
  if(!exp.length)h+=`<tr><td colspan="6" class="emp">No expenses recorded</td></tr>`;
  exp.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e=>{
    const catCols={Staff:'background:#dbeafe;color:#1e40af','Supplies/Consumables':'background:#d1fae5;color:#065f46','Drugs/Stock Purchase':'background:#ede9fe;color:#5b21b6','Utilities':'background:#fef3c7;color:#92400e','Equipment':'background:#fee2e2;color:#991b1b'};
    const cs=catCols[e.category]||'background:#f1f5f9;color:#475569';
    h+=`<tr><td>${e.date}</td><td><span class="exp-cat" style="${cs};">${e.category}</span></td><td>${e.description}</td><td><b style="color:var(--d);">$${e.amount.toFixed(2)}</b></td><td>${e.ref||'â€”'}</td><td>${e.by}</td></tr>`;
  });
  h+=`<tr style="font-weight:700;background:var(--lt);"><td colspan="3">TOTAL</td><td style="color:var(--d);">$${total.toFixed(2)}</td><td colspan="2"></td></tr>`;
  document.getElementById('table-exp').innerHTML=h;
}
function saveExpense(){
  const desc=document.getElementById('expDesc').value.trim();
  const amt=parseFloat(document.getElementById('expAmt').value)||0;
  if(!desc||!amt)return alert('Enter description and amount.');
  const date=document.getElementById('expDate').value?new Date(document.getElementById('expDate').value).toLocaleDateString():new Date().toLocaleDateString();
  expenses.push({id:'E-'+Date.now().toString().slice(-6),date,category:document.getElementById('expCat').value,description:desc,amount:amt,ref:document.getElementById('expRef').value,by:currentUser.name});
  save();cModal('exp-modal');renderExpenses();
  document.getElementById('expDate').value='';document.getElementById('expDesc').value='';document.getElementById('expAmt').value='';document.getElementById('expRef').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdmin(){
  let h=`<tr><th>Name</th><th>Username</th><th>Sections</th><th>Admin</th><th>Actions</th></tr>`;
  staffList.forEach(s=>{
    const sects=s.isAdmin?'<span class="sp2">All Sections</span>':(s.sections||[]).map(x=>`<span class="sp2">${SEC_LABELS[x]||x}</span>`).join('');
    h+=`<tr><td><b>${s.name}</b></td><td>${s.username}</td><td>${sects}</td><td>${s.isAdmin?'âœ…':''}</td>
      <td><div style="display:flex;gap:3px;">
        <button class="bsm bo" onclick="oStaffModal('${s.id}')">Edit</button>
        <button class="bsm bd2" onclick="delStaff('${s.id}')">Delete</button>
      </div></td></tr>`;
  });
  document.getElementById('table-staff').innerHTML=h;
}
function oStaffModal(id){
  const s=id?staffList.find(x=>x.id===id):null;
  document.getElementById('staff-modal-title').innerText=s?'Edit Staff':'Add Staff';
  document.getElementById('staffEid').value=id||'';
  document.getElementById('staffName').value=s?s.name:'';document.getElementById('staffUser').value=s?s.username:'';
  document.getElementById('staffPass').value=s?s.password:'';document.getElementById('staffAdmin').checked=s?s.isAdmin:false;
  const assigned=s?s.sections||[]:[];
  document.getElementById('sec-checks').innerHTML=ALL_SECS.map(sec=>`<label style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;background:var(--lt);padding:4px 9px;border-radius:5px;font-size:12px;text-transform:none;"><input type="checkbox" name="sc_${sec}" value="${sec}" style="width:auto;margin:0;" ${assigned.includes(sec)?'checked':''}> ${SEC_LABELS[sec]}</label>`).join('');
  oModal('staff-modal');
}
function saveStaff(){
  const name=document.getElementById('staffName').value.trim();
  const username=document.getElementById('staffUser').value.trim();
  const password=document.getElementById('staffPass').value;
  const isAdmin=document.getElementById('staffAdmin').checked;
  if(!name||!username||!password)return alert('Fill all required fields.');
  const sections=ALL_SECS.filter(sec=>document.querySelector(`input[name="sc_${sec}"]`)?.checked);
  const eid=document.getElementById('staffEid').value;
  if(eid){const s=staffList.find(x=>x.id===eid);if(!s)return;s.name=name;s.username=username;s.password=password;s.isAdmin=isAdmin;s.sections=sections;}
  else{if(staffList.some(s=>s.username===username))return alert('Username already exists.');staffList.push({id:'S-'+Date.now().toString().slice(-6),name,username,password,isAdmin,sections});}
  save();cModal('staff-modal');renderAdmin();
}
function delStaff(id){if(!confirm('Delete this staff member?'))return;staffList=staffList.filter(s=>s.id!==id);save();renderAdmin();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVOICE PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printInvoice(id){
  const v=visits.find(x=>x.id===id);const p=patients.find(x=>x.id===v.patId);const tot=totalBill(v);
  document.getElementById('pra-sub').innerText='Invoice / Receipt';
  document.getElementById('pra-con').innerHTML=`<p style="font-size:12px;line-height:2;"><b>Patient:</b>${v.name} &nbsp;<b>Age:</b>${p?p.ageVal+' '+p.ageUnit:'â€”'} &nbsp;<b>Gender:</b>${p?p.gender:'â€”'} &nbsp;<b>Date:</b>${v.date} &nbsp;<b>ID:</b>${v.id}</p>
    <table class="pit"><tr><th>#</th><th>Description</th><th>Type</th><th>Qty</th><th>Unit Price</th><th>Amount</th></tr>
    ${v.consultFee?`<tr><td>1</td><td>Consultation Fee</td><td>CONSULT</td><td>1</td><td>$${v.consultFee.toFixed(2)}</td><td>$${v.consultFee.toFixed(2)}</td></tr>`:''}
    ${(v.labs||[]).filter(l=>l.name).map((l,i)=>`<tr><td>${i+2}</td><td>${l.name}</td><td>LAB</td><td>1</td><td>$${l.price.toFixed(2)}</td><td>$${l.price.toFixed(2)}</td></tr>`).join('')}
    ${(v.radiology||[]).filter(r=>r.name).map((r,i)=>`<tr><td>${i+2}</td><td>${r.name}</td><td>RAD</td><td>1</td><td>$${r.price.toFixed(2)}</td><td>$${r.price.toFixed(2)}</td></tr>`).join('')}
    ${(v.prescriptions||[]).filter(r=>r.name).map((r,i)=>`<tr><td>${i+2}</td><td>${r.name} ${r.strength||''}</td><td>RX</td><td>${r.qty}</td><td>$${r.price.toFixed(2)}</td><td>$${(r.price*r.qty).toFixed(2)}</td></tr>`).join('')}
    ${v.discount?`<tr style="color:green;"><td colspan="5" style="text-align:right;">Discount (${v.discountReason||''})</td><td>-$${v.discount.toFixed(2)}</td></tr>`:''}
    <tr style="font-weight:700;"><td colspan="5" style="text-align:right;">TOTAL</td><td>$${tot.toFixed(2)}</td></tr></table>
    <div style="margin-top:10px;font-size:13px;"><b>Paid:</b>$${v.totalPaid.toFixed(2)} &nbsp;<b>Balance:</b>$${(tot-v.totalPaid).toFixed(2)} &nbsp;<b>Status:</b>${billStatus(v)}</div>
    ${v.payments?.length?`<div style="margin-top:8px;font-size:12px;border-top:1px solid #ccc;padding-top:6px;"><b>Payments:</b><br>${v.payments.map(pp=>`${pp.time} â€” $${pp.amount.toFixed(2)} via ${pp.method} (${pp.by})`).join('<br>')}</div>`:''}
    <div style="font-size:11px;color:#666;border-top:1px solid #ccc;padding-top:6px;margin-top:10px;">TALI MEDICALS v3.1 | Printed: ${new Date().toLocaleString()}</div>`;
  window.print();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INJECT REG FORM (Nurse / Doctor tabs)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function injectReg(containerId){
  const c=document.getElementById(containerId);if(!c)return;
  c.innerHTML=`<div class="card"><h3 style="margin-bottom:10px;">Register New Patient</h3>
    <div class="g"><div><label>Full Name *</label><input id="${containerId}-pName"></div><div><label>Gender</label><select id="${containerId}-pGender"><option>Male</option><option>Female</option></select></div><div><label>Age *</label><div style="display:flex;gap:5px;margin-top:2px;"><input type="number" id="${containerId}-pAgeVal" placeholder="32" min="0" style="width:55%;margin:0;"><select id="${containerId}-pAgeUnit" style="width:45%;margin:0;"><option value="years">Years</option><option value="months">Months</option><option value="days">Days</option></select></div></div><div><label>Phone</label><input id="${containerId}-pPhone"></div><div><label>Address</label><input id="${containerId}-pAddress"></div></div>
    <div class="g2"><div><label>Consultation Type</label><select id="${containerId}-pCT"><option value="GENERAL">General</option><option value="LAB_ONLY">Lab Only</option><option value="RADIOLOGY">Radiology</option><option value="DENTAL">Dental</option><option value="ENT">ENT</option><option value="OTHER_SPECIAL">Other Special</option></select></div></div>
    <button onclick="regPatFrom('${containerId}')" class="bp" style="margin-top:10px;">Register & Route</button></div>
  <div class="card"><input id="${containerId}-search" placeholder="Search patients..." onkeyup="renderPatsIn('${containerId}')" style="margin-bottom:8px;"><table id="${containerId}-table"></table></div>`;
  renderPatsIn(containerId);
}
function regPatFrom(p){
  const gv=id=>document.getElementById(`${p}-${id}`)?.value;
  const name=gv('pName')?.trim();const ageVal=gv('pAgeVal');
  if(!name||!ageVal)return alert('Enter name and age.');
  const ct=gv('pCT')||'GENERAL';
  const pId='P-'+Date.now().toString().slice(-7);
  patients.push({id:pId,name,gender:gv('pGender'),ageVal:parseInt(ageVal),ageUnit:gv('pAgeUnit'),phone:gv('pPhone')||'',address:gv('pAddress')||'',kinName:'',kinPhone:''});
  const vId='V-'+Date.now().toString().slice(-7);
  const v=newVisit(vId,pId,name,ct);lg(v,'Registered','By '+currentUser.name);visits.push(v);
  save();renderPatsIn(p);alert(`${name} registered.`);
  ['pName','pPhone','pAddress','pAgeVal'].forEach(f=>{const el=document.getElementById(`${p}-${f}`);if(el)el.value='';});
}
function renderPatsIn(p){
  const term=(document.getElementById(`${p}-search`)?.value||'').toLowerCase();
  const t=document.getElementById(`${p}-table`);if(!t)return;
  let h=`<tr><th>Name</th><th>Age</th><th>Gender</th><th>Last Status</th><th>Action</th></tr>`;
  patients.filter(x=>x.name.toLowerCase().includes(term)).forEach(x=>{
    const pv=visits.filter(v=>v.patId===x.id);const last=pv.length?pv[pv.length-1]:null;
    const st=last?`<span class="badge bgr" style="font-size:10px;">${last.status.replace(/_/g,' ')}</span>`:'-';
    h+=`<tr><td><b>${x.name}</b></td><td>${x.ageVal} ${x.ageUnit}</td><td>${x.gender}</td><td>${st}</td><td><button class="bsm bo" onclick="startVisit('${x.id}','${enc(x.name)}')">+ Visit</button></td></tr>`;
  });
  t.innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function totalBillGross(v){
  let t=v.consultFee||0;
  t+=(v.labs||[]).filter(l=>l.name).reduce((s,l)=>s+l.price,0);
  t+=(v.radiology||[]).filter(r=>r.name).reduce((s,r)=>s+r.price,0);
  t+=(v.prescriptions||[]).filter(r=>r.name).reduce((s,r)=>s+r.price*r.qty,0);
  return t;
}
function totalBill(v){return Math.max(0,totalBillGross(v)-(v.discount||0));}
function billStatus(v){
  const t=totalBill(v);if(!t)return'PAID';
  if(v.totalPaid<=0)return'PENDING';
  if(v.totalPaid<t-0.001)return'PARTIAL';
  return'PAID';
}
function payBadge(v){
  const t=totalBill(v);if(!t)return`<span class="pb" style="background:#f1f5f9;color:#64748b;">NO BILL</span>`;
  const bs=billStatus(v);
  const m={PENDING:'background:#fee2e2;color:#991b1b',PARTIAL:'background:#fef3c7;color:#92400e',PAID:'background:#d1fae5;color:#065f46'};
  const l={PENDING:'âš  UNPAID',PARTIAL:'ğŸ’³ PARTIAL',PAID:'âœ“ PAID'};
  return`<span class="pb" style="${m[bs]}">${l[bs]}</span>`;
}
function oModal(id){document.getElementById(id)?.classList.add('open');}
function cModal(id){document.getElementById(id)?.classList.remove('open');}
function enc(s){return encodeURIComponent(s);}
function dec(s){return decodeURIComponent(s);}
document.addEventListener('click',e=>{if(e.target.classList.contains('mo'))e.target.classList.remove('open');});
</script>
</body>
</html>
